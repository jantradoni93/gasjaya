<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Timbangan Gas Jaya</title>
    
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCN0VeIOgPIK-MNPFoNzqw-GnwZXs9Dk8A",
            authDomain: "gasjaya-e24de.firebaseapp.com",
            projectId: "gasjaya-e24de",
            storageBucket: "gasjaya-e24de.firebasestorage.app",
            messagingSenderId: "924363516081",
            appId: "1:924363516081:web:fd90386ab0040368bc5a90"
        };

        const appFB = initializeApp(firebaseConfig);
        const db = getFirestore(appFB);

        enableIndexedDbPersistence(db).catch(() => console.log("Offline mode active"));

        window.dbCloud = db;
        window.dbCollection = collection(db, "transaksi_gas");
        window.fbAdd = addDoc;
        window.fbTime = serverTimestamp;
    </script>

    <style>
        /* CSS ASLI ANDA */
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#2563eb;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--bg:#f8fafc;--card:#fff;--text:#1e293b;--border:#e2e8f0}
        body{font-family:-apple-system,sans-serif;background:var(--bg);color:var(--text);padding-bottom:2rem}
        .header{background:linear-gradient(135deg,var(--primary)0%,#1d4ed8 100%);color:#fff;padding:1rem;position:sticky;top:0;z-index:100}
        .container{max-width:1200px;margin:0 auto;padding:1rem}
        
        /* Navigasi */
        .nav{display:flex;gap:0.5rem;overflow-x:auto;padding:1rem 0;scrollbar-width:none}
        .nav-btn{padding:0.6rem 1rem;background:rgba(255,255,255,0.1);border:none;color:#fff;border-radius:0.5rem;cursor:pointer;white-space:nowrap}
        .nav-btn.active{background:#fff;color:var(--primary);font-weight:bold}

        .card{background:#fff;border-radius:0.75rem;padding:1.25rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:1rem}
        .form-group{margin-bottom:1rem}
        label{display:block;font-size:0.875rem;font-weight:600;margin-bottom:0.25rem}
        input,select{width:100%;padding:0.75rem;border:1px solid var(--border);border-radius:0.5rem;font-size:16px}
        
        .btn{padding:0.75rem 1rem;border:none;border-radius:0.5rem;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:0.5rem}
        .btn-primary{background:var(--primary);color:#fff;width:100%}
        .btn-sm{padding:0.4rem 0.8rem;font-size:0.75rem}
        .btn-print{background:var(--warning);color:#000}
        
        table{width:100%;border-collapse:collapse;margin-top:1rem}
        th,td{padding:0.75rem;text-align:left;border-bottom:1px solid var(--border);font-size:0.875rem}

        /* KHUSUS PRINT NOTA */
        #area-nota{display:none}
        @media print {
            body * { visibility: hidden; }
            #area-nota, #area-nota * { visibility: visible; }
            #area-nota { display: block; position: absolute; left: 0; top: 0; width: 100%; padding: 10px; font-family: 'Courier New', monospace; }
            .no-print { display: none; }
        }
        .nota-box{border:1px dashed #000;padding:15px;max-width:300px;margin:auto}
    </style>
</head>
<body>

    <header class="header">
        <div class="container">
            <h2>‚öñÔ∏è Timbangan Gas Jaya</h2>
            <nav class="nav">
                <button class="nav-btn active" onclick="app.tab('input', this)">Input</button>
                <button class="nav-btn" onclick="app.tab('riwayat', this)">Riwayat</button>
                <button class="nav-btn" onclick="app.tab('laporan', this)">Laporan</button>
                <button class="nav-btn" onclick="app.tab('settings', this)">Pengaturan</button>
            </nav>
        </div>
    </header>

    <main class="container">
        <section id="tab-input" class="card">
            <form onsubmit="app.save(event)">
                <div class="form-group"><label>Tanggal</label><input type="date" id="inp-tgl" required></div>
                <div class="form-group"><label>Supplier</label><select id="inp-sup" required></select></div>
                <div class="form-group"><label>Customer/Supir</label><input type="text" id="inp-nama" required></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                    <div class="form-group"><label>Bruto</label><input type="number" step="0.01" id="inp-bruto" oninput="app.calc()" required></div>
                    <div class="form-group"><label>Tara</label><input type="number" step="0.01" id="inp-tara" oninput="app.calc()" required></div>
                </div>
                <div class="form-group"><label>Netto</label><input type="text" id="inp-netto" readonly style="background:#f1f5f9"></div>
                <div class="form-group"><label>Harga/Kg</label><input type="number" id="inp-harga" oninput="app.calc()" required></div>
                <h3 id="display-total" style="margin-bottom:1rem;color:var(--primary)">Total: Rp 0</h3>
                <button type="submit" class="btn btn-primary">üíæ Simpan & Sinkron Cloud</button>
            </form>
        </section>

        <section id="tab-riwayat" class="card" style="display:none">
            <h3>üìã Daftar Timbangan</h3>
            <div style="overflow-x:auto">
                <table>
                    <thead><tr><th>Tanggal</th><th>Nama</th><th>Netto</th><th>Aksi</th></tr></thead>
                    <tbody id="list-riwayat"></tbody>
                </table>
            </div>
        </section>

        <section id="tab-laporan" class="card" style="display:none">
            <h3>üí∞ Ringkasan Pembayaran</h3>
            <div id="list-laporan"></div>
        </section>

        <section id="tab-settings" class="card" style="display:none">
            <h3>‚öôÔ∏è Pengaturan Supplier</h3>
            <div class="form-group">
                <input type="text" id="new-sup" placeholder="Nama Supplier Baru...">
                <button class="btn btn-primary" onclick="app.addSup()" style="margin-top:0.5rem">+ Tambah Supplier</button>
            </div>
            <hr><br>
            <button class="btn btn-sm" style="background:var(--danger);color:#fff" onclick="app.clearData()">Hapus Semua Data</button>
        </section>
    </main>

    <div id="area-nota">
        <div class="nota-box">
            <center>
                <strong>GAS JAYA - MUARA BADAK</strong><br>
                Nota Timbangan Digital<br>
                --------------------------
            </center>
            <table style="width:100%;font-size:12px">
                <tr><td>Tgl:</td><td id="n-tgl"></td></tr>
                <tr><td>Nama:</td><td id="n-nama"></td></tr>
                <tr><td>Sup:</td><td id="n-sup"></td></tr>
                <tr><td colspan="2">--------------------------</td></tr>
                <tr><td>Bruto:</td><td id="n-bruto"></td></tr>
                <tr><td>Tara:</td><td id="n-tara"></td></tr>
                <tr><td>Netto:</td><td id="n-netto"></td></tr>
                <tr><td>Harga:</td><td id="n-harga"></td></tr>
                <tr><td colspan="2">--------------------------</td></tr>
                <tr><td><strong>TOTAL:</strong></td><td><strong id="n-total"></strong></td></tr>
            </table>
            <br>
            <center>Terima Kasih</center>
        </div>
    </div>

    <script>
        const app = (() => {
            let db = JSON.parse(localStorage.getItem('gas_db') || '[]');
            let sups = JSON.parse(localStorage.getItem('gas_sups') || '["GUDANG PUSAT"]');

            const init = () => {
                document.getElementById('inp-tgl').valueAsDate = new Date();
                renderSups();
                renderRiwayat();
            };

            const tab = (id, btn) => {
                document.querySelectorAll('section').forEach(s => s.style.display = 'none');
                document.getElementById('tab-'+id).style.display = 'block';
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                if(id === 'laporan') renderLaporan();
            };

            const calc = () => {
                const b = parseFloat(document.getElementById('inp-bruto').value) || 0;
                const t = parseFloat(document.getElementById('inp-tara').value) || 0;
                const h = parseFloat(document.getElementById('inp-harga').value) || 0;
                const n = b - t;
                document.getElementById('inp-netto').value = n.toFixed(2);
                document.getElementById('display-total').innerText = `Total: Rp ${(n * h).toLocaleString()}`;
            };

            const save = async (e) => {
                e.preventDefault();
                const item = {
                    id: Date.now(),
                    tgl: document.getElementById('inp-tgl').value,
                    sup: document.getElementById('inp-sup').value,
                    nama: document.getElementById('inp-nama').value,
                    bruto: document.getElementById('inp-bruto').value,
                    tara: document.getElementById('inp-tara').value,
                    netto: document.getElementById('inp-netto').value,
                    harga: document.getElementById('inp-harga').value,
                    total: parseFloat(document.getElementById('inp-netto').value) * parseFloat(document.getElementById('inp-harga').value)
                };

                db.unshift(item);
                localStorage.setItem('gas_db', JSON.stringify(db));

                // SYNC KE GOOGLE FIREBASE
                if(window.fbAdd) {
                    try {
                        await window.fbAdd(window.dbCollection, {...item, created: window.fbTime()});
                    } catch(err) { console.log("Offline - Data disimpan di HP"); }
                }

                alert("Data Berhasil Disimpan!");
                document.getElementById('inp-nama').value = "";
                document.getElementById('inp-bruto').value = "";
                renderRiwayat();
            };

            const renderRiwayat = () => {
                const html = db.map(i => `
                    <tr>
                        <td>${i.tgl}</td>
                        <td>${i.nama}</td>
                        <td>${i.netto} kg</td>
                        <td>
                            <button class="btn btn-sm btn-print" onclick="app.print(${i.id})">üñ®Ô∏è Cetak</button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('list-riwayat').innerHTML = html;
            };

            const renderLaporan = () => {
                const res = db.reduce((acc, curr) => {
                    acc[curr.sup] = (acc[curr.sup] || 0) + curr.total;
                    return acc;
                }, {});
                
                document.getElementById('list-laporan').innerHTML = Object.keys(res).map(s => `
                    <div style="display:flex;justify-content:space-between;padding:0.5rem;border-bottom:1px solid #eee">
                        <span>${s}</span>
                        <strong>Rp ${res[s].toLocaleString()}</strong>
                    </div>
                `).join('') || 'Belum ada data.';
            };

            const print = (id) => {
                const i = db.find(x => x.id === id);
                document.getElementById('n-tgl').innerText = i.tgl;
                document.getElementById('n-nama').innerText = i.nama;
                document.getElementById('n-sup').innerText = i.sup;
                document.getElementById('n-bruto').innerText = i.bruto + " kg";
                document.getElementById('n-tara').innerText = i.tara + " kg";
                document.getElementById('n-netto').innerText = i.netto + " kg";
                document.getElementById('n-harga').innerText = "Rp " + parseInt(i.harga).toLocaleString();
                document.getElementById('n-total').innerText = "Rp " + i.total.toLocaleString();
                window.print();
            };

            const addSup = () => {
                const n = document.getElementById('new-sup').value;
                if(!n) return;
                sups.push(n.toUpperCase());
                localStorage.setItem('gas_sups', JSON.stringify(sups));
                renderSups();
                document.getElementById('new-sup').value = "";
            };

            const renderSups = () => {
                document.getElementById('inp-sup').innerHTML = sups.map(s => `<option value="${s}">${s}</option>`).join('');
            };

            const clearData = () => { if(confirm("Hapus semua riwayat?")) { localStorage.removeItem('gas_db'); location.reload(); }};

            return { init, tab, calc, save, print, addSup, clearData };
        })();

        app.init();
    </script>
</body>
</html>
