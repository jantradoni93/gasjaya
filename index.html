<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Timbangan Gas Jaya - Firebase Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* CSS tetap sama dengan versi asli Anda */
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#2563eb;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#06b6d4;--bg:#f8fafc;--card:#fff;--text:#1e293b;--border:#e2e8f0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;padding-bottom:70px}
        .container{max-width:800px;margin:0 auto;padding:16px}
        header{background:var(--primary);color:#fff;padding:20px 16px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,0.1);margin-bottom:20px;border-radius:0 0 20px 20px}
        .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:16px;border:1px solid var(--border)}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .form-group{margin-bottom:12px}
        label{display:block;font-size:14px;font-weight:600;margin-bottom:4px;color:#64748b}
        input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:16px;outline:none;transition:border-color 0.2s}
        input:focus{border-color:var(--primary)}
        .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 20px;border-radius:8px;border:none;font-weight:600;cursor:pointer;transition:all 0.2s;gap:8px;width:100%;font-size:16px}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-success{background:var(--success);color:#fff}
        .summary{background:#f1f5f9;padding:12px;border-radius:8px;margin-top:12px}
        .summary-item{display:flex;justify-content:space-between;margin-bottom:4px}
        .summary-total{border-top:2px solid var(--border);padding-top:8px;margin-top:8px;font-weight:bold;font-size:18px;color:var(--primary)}
        table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
        th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
        th{background:#f8fafc;font-weight:600}
        .nav-bottom{position:fixed;bottom:0;left:0;right:0;background:#fff;display:flex;justify-content:space-around;padding:10px;box-shadow:0 -2px 10px rgba(0,0,0,0.1);z-index:100}
        .nav-btn{background:none;border:none;color:#64748b;font-size:12px;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer}
        .nav-btn.active{color:var(--primary)}
        .status-badge{padding:4px 8px;border-radius:99px;font-size:12px;font-weight:600}
        .status-cash{background:#dcfce7;color:#166534}
        .status-bon{background:#fee2e2;color:#991b1b}
        .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:99px;z-index:1000;display:none}
        #page-input, #page-riwayat, #page-settings { display: none; }
        .active-page { display: block !important; }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>

    <header>
        <h1 style="font-size:20px">TIMBANGAN GAS JAYA</h1>
        <p id="online-status" style="font-size:12px; opacity:0.8">Menghubungkan ke Cloud...</p>
    </header>

    <div class="container">
        <div id="page-input" class="active-page">
            <div class="card">
                <form id="form-transaksi">
                    <div class="grid">
                        <div class="form-group">
                            <label>Tanggal</label>
                            <input type="date" id="inp-tanggal" required>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="inp-status">
                                <option value="CASH">CASH</option>
                                <option value="BON">BON</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Nama Supir / Pelanggan</label>
                        <input type="text" id="inp-supir" placeholder="Contoh: Budi" required>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label>No. Plat</label>
                            <input type="text" id="inp-plat" placeholder="BK 1234 XX">
                        </div>
                        <div class="form-group">
                            <label>Supplier</label>
                            <select id="inp-supplier"></select>
                        </div>
                    </div>
                    <hr style="margin:10px 0; border:0; border-top:1px solid #eee">
                    <div class="grid">
                        <div class="form-group">
                            <label>Bruto (Isi)</label>
                            <input type="number" id="inp-bruto" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label>Tara (Kosong)</label>
                            <input type="number" id="inp-tara" step="0.01" placeholder="0.00" required>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label>Susut/Pot (kg)</label>
                            <input type="number" id="inp-potongan" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Harga / kg</label>
                            <input type="number" id="inp-harga" value="18500">
                        </div>
                    </div>

                    <div class="summary">
                        <div class="summary-item"><span>Netto:</span> <span id="calc-netto">0.00</span> kg</div>
                        <div class="summary-total">Total: Rp <span id="calc-total">0</span></div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="margin-top:15px">SIMPAN KE CLOUD</button>
                </form>
            </div>
        </div>

        <div id="page-riwayat">
            <div class="card">
                <h3>Riwayat Transaksi Cloud</h3>
                <div style="overflow-x:auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Nama</th>
                                <th>Netto</th>
                                <th>Total</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <nav class="nav-bottom">
        <button class="nav-btn active" onclick="app.switchTab('input', this)">
            <span>üìù</span><div>Input</div>
        </button>
        <button class="nav-btn" onclick="app.switchTab('riwayat', this)">
            <span>üìä</span><div>Riwayat</div>
        </button>
    </nav>

    <script>
        // 1. KONFIGURASI FIREBASE ANDA
        const firebaseConfig = {
            apiKey: "AIzaSyCN0VeIOgPIK-MNPFoNzqw-GnwZXs9Dk8A",
            authDomain: "gasjaya-e24de.firebaseapp.com",
            projectId: "gasjaya-e24de",
            storageBucket: "gasjaya-e24de.firebasestorage.app",
            messagingSenderId: "924363516081",
            appId: "1:924363516081:web:fd90386ab0040368bc5a90",
            measurementId: "G-Q2QFS7EL7W"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Aktifkan Offline Persistence agar aplikasi tetap jalan tanpa internet
        db.enablePersistence().catch((err) => console.log("Offline mode error", err));

        // 2. LOGIKA APLIKASI
        const app = (function() {
            let state = { transactions: [] };

            const init = () => {
                setupEventListeners();
                setCurrentDate();
                listenToCloudData(); // Ambil data real-time dari Firebase
            };

            const setupEventListeners = () => {
                document.getElementById('form-transaksi').addEventListener('submit', saveToFirebase);
                ['inp-bruto', 'inp-tara', 'inp-potongan', 'inp-harga'].forEach(id => {
                    document.getElementById(id).addEventListener('input', calculate);
                });
            };

            const setCurrentDate = () => {
                document.getElementById('inp-tanggal').valueAsDate = new Date();
            };

            const calculate = () => {
                const bruto = parseFloat(document.getElementById('inp-bruto').value) || 0;
                const tara = parseFloat(document.getElementById('inp-tara').value) || 0;
                const pot = parseFloat(document.getElementById('inp-potongan').value) || 0;
                const harga = parseFloat(document.getElementById('inp-harga').value) || 0;

                const netto = Math.max(0, bruto - tara - pot);
                // Logika pembulatan kebawah (floor) sesuai permintaan Anda sebelumnya
                const total = Math.floor(netto * harga);

                document.getElementById('calc-netto').innerText = netto.toFixed(2);
                document.getElementById('calc-total').innerText = total.toLocaleString('id-ID');
                
                return { netto, total };
            };

            const saveToFirebase = async (e) => {
                e.preventDefault();
                const { netto, total } = calculate();

                const data = {
                    tanggal: document.getElementById('inp-tanggal').value,
                    supir: document.getElementById('inp-supir').value,
                    plat: document.getElementById('inp-plat').value,
                    supplier: document.getElementById('inp-supplier').value,
                    bruto: parseFloat(document.getElementById('inp-bruto').value),
                    tara: parseFloat(document.getElementById('inp-tara').value),
                    netto: netto,
                    total: total,
                    status: document.getElementById('inp-status').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    showToast("Sedang menyimpan...");
                    await db.collection("transaksi").add(data);
                    showToast("‚úÖ Berhasil disimpan ke Cloud!");
                    e.target.reset();
                    setCurrentDate();
                    calculate();
                } catch (error) {
                    showToast("‚ùå Gagal: " + error.message);
                }
            };

            const listenToCloudData = () => {
                db.collection("transaksi").orderBy("createdAt", "desc").limit(50)
                .onSnapshot((snapshot) => {
                    const list = [];
                    snapshot.forEach(doc => list.push(doc.data()));
                    renderTable(list);
                    document.getElementById('online-status').innerText = "Cloud Terhubung (Online)";
                }, (error) => {
                    document.getElementById('online-status').innerText = "Mode Offline Aktif";
                });
            };

            const renderTable = (data) => {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = data.map(t => `
                    <tr>
                        <td>${t.tanggal}</td>
                        <td>${t.supir}</td>
                        <td>${t.netto.toFixed(2)}</td>
                        <td>${t.total.toLocaleString('id-ID')}</td>
                        <td><span class="status-badge ${t.status === 'CASH' ? 'status-cash' : 'status-bon'}">${t.status}</span></td>
                    </tr>
                `).join('');
            };

            const switchTab = (tab, btn) => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.getElementById('page-input').classList.remove('active-page');
                document.getElementById('page-riwayat').classList.remove('active-page');
                
                document.getElementById('page-' + tab).classList.add('active-page');
            };

            const showToast = (msg) => {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            };

            return { init, switchTab };
        })();

        app.init();
    </script>
</body>
</html>
