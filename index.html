<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Timbangan Gas Jaya</title>
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Sistem Pencatatan Timbangan Online & Offline">

    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gas Jaya">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, serverTimestamp, enableIndexedDbPersistence 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- GANTI DENGAN KODE FIREBASE ANDA DI SINI ---
        const firebaseConfig = {
  		apiKey: "AIzaSyCN0VeIOgPIK-MNPFoNzqw-GnwZXs9Dk8A",
  		authDomain: "gasjaya-e24de.firebaseapp.com",
  		projectId: "gasjaya-e24de",
  		storageBucket: "gasjaya-e24de.firebasestorage.app",
  		messagingSenderId: "924363516081",
  		appId: "1:924363516081:web:fd90386ab0040368bc5a90",
  		measurementId: "G-Q2QFS7EL7W"
	};

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Aktifkan Mode Offline Firestore
        enableIndexedDbPersistence(db).catch((err) => {
            console.error("Offline Persistence Gagal:", err.code);
        });

        // Ekspos ke global agar bisa dipakai di script app
        window.dbCloud = db;
        window.dbCollection = collection(db, "transaksi_gas");
    </script>

    <style>
        /* Style tetap sama dengan versi Anda sebelumnya */
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#2563eb;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#06b6d4;--bg:#f8fafc;--card:#fff;--text:#1e293b;--border:#e2e8f0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
        .header{background:linear-gradient(135deg,var(--primary)0%,#1d4ed8 100%);color:#fff;padding:1rem;position:sticky;top:0;z-index:100}
        .container{max-width:1400px;margin:0 auto;padding:1rem}
        .nav-tabs{display:flex;gap:.5rem;margin-bottom:1rem;overflow-x:auto;padding-bottom:.5rem;scrollbar-width:none}
        .tab-btn{padding:.6rem 1.2rem;border:none;background:var(--card);color:var(--text);border-radius:.5rem;cursor:pointer;font-weight:600;white-space:nowrap;transition:all .2s;border:1px solid var(--border);display:flex;align-items:center;gap:.5rem}
        .tab-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .card{background:var(--card);border-radius:.75rem;padding:1.25rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:1.5rem;border:1px solid var(--border)}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem}
        .form-group{margin-bottom:1rem}
        .form-group label{display:block;margin-bottom:.5rem;font-weight:600;font-size:.875rem}
        input,select,textarea{width:100%;padding:.75rem;border:1.5px solid var(--border);border-radius:.5rem;font-size:1rem}
        .btn{padding:.75rem 1.5rem;border:none;border-radius:.5rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:.5rem;width:100%}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;padding:1rem;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:#fff;padding:1.5rem;border-radius:.75rem;width:100%;max-width:500px}
        table{width:100%;border-collapse:collapse;margin-top:1rem}
        th,td{padding:1rem;text-align:left;border-bottom:1px solid var(--border)}
        .print-area{display:none}
        @media print{
            body *{visibility:hidden}
            .print-area,.print-area *{visibility:visible}
            .print-area{display:block;position:absolute;left:0;top:0;width:80mm}
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container" style="display:flex;justify-content:space-between;align-items:center">
            <div>
                <h1 style="font-size:1.25rem">Timbangan Gas Jaya</h1>
                <p id="status-sync" style="font-size:.75rem;opacity:.8">Mode Cloud Aktif</p>
            </div>
            <div id="status-koneksi" class="badge">Online</div>
        </div>
    </header>

    <main class="container">
        <nav class="nav-tabs">
            <button class="tab-btn active" onclick="app.switchTab('input')">üìù Input</button>
            <button class="tab-btn" onclick="app.switchTab('riwayat')">üìä Riwayat</button>
            <button class="tab-btn" onclick="app.switchTab('laporan')">üìà Laporan</button>
            <button class="tab-btn" onclick="app.switchTab('pengaturan')">‚öôÔ∏è Pengaturan</button>
        </nav>

        <section id="tab-input" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h2 style="margin-bottom:1.25rem">Data Transaksi</h2>
                    <form id="form-transaksi">
                        <div class="form-group">
                            <label>Supplier</label>
                            <div style="display:flex;gap:0.5rem">
                                <select id="supplier-select" onchange="app.onSupplierChange()">
                                    <option value="">-- Pilih Supplier --</option>
                                </select>
                                <button type="button" class="btn btn-outline" style="width:auto" onclick="app.openSupplierModal()">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Nama Customer</label>
                            <input type="text" id="nama" placeholder="Nama..." required>
                        </div>
                        <div class="grid" style="grid-template-columns:1fr 1fr;gap:.75rem">
                            <div class="form-group">
                                <label>Bruto (Kg)</label>
                                <input type="number" step="0.01" id="bruto" placeholder="0.00" required oninput="app.calculateWeight()">
                            </div>
                            <div class="form-group">
                                <label>Tara (Kg)</label>
                                <input type="number" step="0.01" id="tara" placeholder="0.00" required oninput="app.calculateWeight()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Netto</label>
                            <input type="number" id="netto" readonly style="background:#f1f5f9;font-weight:bold;color:var(--primary)">
                        </div>
                        <button type="button" class="btn btn-primary" onclick="app.saveTransaction()">üíæ Simpan & Sinkron Cloud</button>
                    </form>
                </div>
            </div>
        </section>

        <section id="tab-riwayat" class="tab-content" style="display:none">
            <div class="card">
                <div id="history-body"></div>
            </div>
        </section>
        
        </main>

    <div id="modal-supplier" class="modal">
        <div class="modal-content">
            <h3>Kelola Supplier</h3>
            <div class="form-group">
                <input type="text" id="new-supplier-name" placeholder="Nama Supplier...">
                <button class="btn btn-primary" onclick="app.saveSupplier()" style="margin-top:10px">Tambah</button>
            </div>
            <div id="supplier-list"></div>
            <button class="btn btn-outline" onclick="app.closeSupplierModal()">Tutup</button>
        </div>
    </div>

    <script>
        const app = (() => {
            const STORAGE_KEY = 'gas_jaya_v2';
            const SUPPLIER_KEY = 'gas_jaya_suppliers';
            
            let state = {
                transactions: JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'),
                suppliers: JSON.parse(localStorage.getItem(SUPPLIER_KEY) || '[]')
            };

            const init = () => {
                renderSupplierList();
                updateOnlineStatus();
                window.addEventListener('online', updateOnlineStatus);
                window.addEventListener('offline', updateOnlineStatus);
            };

            const updateOnlineStatus = () => {
                const el = document.getElementById('status-koneksi');
                if (navigator.onLine) {
                    el.textContent = 'Cloud Online';
                    el.style.background = '#dcfce7';
                } else {
                    el.textContent = 'Mode Lokal (Offline)';
                    el.style.background = '#fee2e2';
                }
            };

            const calculateWeight = () => {
                const bruto = parseFloat(document.getElementById('bruto').value) || 0;
                const tara = parseFloat(document.getElementById('tara').value) || 0;
                document.getElementById('netto').value = (bruto - tara).toFixed(2);
            };

            // FUNGSI SIMPAN DENGAN FIREBASE
            const saveTransaction = async () => {
                const nama = document.getElementById('nama').value;
                const bruto = parseFloat(document.getElementById('bruto').value);
                const tara = parseFloat(document.getElementById('tara').value);
                const netto = parseFloat(document.getElementById('netto').value);
                const supplier = document.getElementById('supplier-select').value;

                if (!nama || isNaN(bruto)) return alert('Isi data dengan lengkap!');

                const data = {
                    nama, bruto, tara, netto, supplier,
                    tanggal: new Date().toISOString()
                };

                // 1. Simpan di Local HP
                state.transactions.unshift({ id: Date.now(), ...data });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state.transactions));

                // 2. Sinkron ke Google Cloud (Firebase)
                if (window.dbCollection) {
                    try {
                        const { addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js");
                        await addDoc(window.dbCollection, {
                            ...data,
                            createdAt: serverTimestamp()
                        });
                        console.log("Berhasil Sinkron ke Google Cloud!");
                    } catch (e) {
                        console.log("Gagal sinkron, data tersimpan di HP. Akan otomatis sinkron saat online.");
                    }
                }

                alert('Data Tersimpan!');
                document.getElementById('form-transaksi').reset();
            };

            const switchTab = (tabId) => {
                document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
                document.getElementById('tab-' + tabId).style.display = 'block';
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.currentTarget.classList.add('active');
            };

            const openSupplierModal = () => document.getElementById('modal-supplier').classList.add('active');
            const closeSupplierModal = () => document.getElementById('modal-supplier').classList.remove('active');

            const saveSupplier = () => {
                const name = document.getElementById('new-supplier-name').value;
                if(!name) return;
                state.suppliers.push({id: Date.now(), name});
                localStorage.setItem(SUPPLIER_KEY, JSON.stringify(state.suppliers));
                renderSupplierList();
                document.getElementById('new-supplier-name').value = '';
            };

            const renderSupplierList = () => {
                const select = document.getElementById('supplier-select');
                select.innerHTML = '<option value="">-- Pilih Supplier --</option>' + 
                    state.suppliers.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
                
                const list = document.getElementById('supplier-list');
                list.innerHTML = state.suppliers.map(s => `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                        <span>${s.name}</span>
                        <button onclick="app.deleteSupplier(${s.id})" style="color:red">Hapus</button>
                    </div>
                `).join('');
            };

            const deleteSupplier = (id) => {
                state.suppliers = state.suppliers.filter(s => s.id !== id);
                localStorage.setItem(SUPPLIER_KEY, JSON.stringify(state.suppliers));
                renderSupplierList();
            };

            return {
                init, calculateWeight, saveTransaction, switchTab,
                openSupplierModal, closeSupplierModal, saveSupplier, deleteSupplier,
                onSupplierChange: () => {}
            };
        })();

        app.init();
    </script>
</body>
</html>
