<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Timbangan Gas Jaya</title>
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Sistem Pencatatan Timbangan Online & Offline">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#2563eb;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#06b6d4;--bg:#f8fafc;--card:#fff;--text:#1e293b;--border:#e2e8f0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
        .header{background:linear-gradient(135deg,var(--primary)0%,#1d4ed8 100%);color:#fff;padding:1rem;position:sticky;top:0;z-index:100}
        .container{max-width:1400px;margin:0 auto;padding:1rem}
        .nav{display:flex;gap:0.5rem;overflow-x:auto;padding:1rem 0;-webkit-overflow-scrolling:touch}
        .nav-btn{padding:0.5rem 1rem;background:rgba(255,255,255,0.1);border:none;color:#fff;border-radius:0.5rem;cursor:pointer;white-space:nowrap;font-size:0.875rem;transition:all 0.2s}
        .nav-btn:hover{background:rgba(255,255,255,0.2)}
        .nav-btn.active{background:#fff;color:var(--primary);font-weight:600}
        .card{background:var(--card);border-radius:0.75rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:1rem;overflow:hidden}
        .card-header{padding:1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem}
        .card-body{padding:1rem}
        .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;margin-bottom:1rem}
        @media(min-width:768px){.stats{grid-template-columns:repeat(4,1fr)}}
        .stat{background:#fff;padding:1rem;border-radius:0.5rem;border-left:4px solid var(--primary);box-shadow:0 1px 3px rgba(0,0,0,0.1)}
        .stat.success{border-left-color:var(--success)}.stat.warning{border-left-color:var(--warning)}.stat.danger{border-left-color:var(--danger)}.stat.info{border-left-color:var(--info)}
        .stat-value{font-size:1.25rem;font-weight:700}
        .form-grid{display:grid;grid-template-columns:1fr;gap:0.75rem}
        @media(min-width:768px){.form-grid{grid-template-columns:repeat(2,1fr)}.span-2{grid-column:span 2}.span-3{grid-column:span 3}}
        .form-group{margin-bottom:0.5rem}
        .form-label{display:block;font-size:0.875rem;font-weight:500;margin-bottom:0.25rem}
        .form-input,.form-select{width:100%;padding:0.75rem;border:1px solid var(--border);border-radius:0.5rem;font-size:16px;background:#fff}
        .form-input:focus,.form-select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,0.1)}
        .input-group{display:flex;position:relative}
        .input-prefix,.input-suffix{position:absolute;top:50%;transform:translateY(-50%);font-size:0.875rem;color:#64748b;font-weight:500}
        .input-prefix{left:0.75rem}.input-suffix{right:0.75rem}
        .input-group .form-input{padding-left:2.5rem}.input-group:has(.input-suffix) .form-input{padding-right:2.5rem;padding-left:0.75rem}
        .btn{padding:0.625rem 1rem;border:none;border-radius:0.5rem;font-size:0.9375rem;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;gap:0.5rem;min-height:44px;transition:all 0.2s}
        .btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:#1d4ed8}
        .btn-success{background:var(--success);color:#fff}.btn-success:hover{background:#059669}
        .btn-warning{background:var(--warning);color:#fff}.btn-warning:hover{background:#d97706}
        .btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#dc2626}
        .btn-info{background:var(--info);color:#fff}.btn-info:hover{background:#0891b2}
        .btn-outline{border:1px solid var(--border);background:#fff;color:var(--text)}.btn-outline:hover{border-color:var(--primary);color:var(--primary)}
        .btn-sm{padding:0.375rem 0.75rem;font-size:0.875rem;min-height:36px}
        .btn-lg{padding:0.75rem 1.5rem;font-size:1rem}
        .btn-secondary{background:#64748b;color:#fff}.btn-secondary:hover{background:#475569}
        .calc-box{background:#f0f9ff;border:1px solid #e0f2fe;border-radius:0.5rem;padding:1rem;margin:1rem 0}
        .calc-row{display:flex;justify-content:space-between;align-items:center;padding:0.5rem 0;border-bottom:1px dashed #cbd5e1}
        .calc-row:last-child{border:none;font-weight:700;color:var(--primary);font-size:1.125rem;border-top:2px solid #bfdbfe;margin-top:0.5rem;padding-top:0.5rem}
        .table-container{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0 -1rem;padding:0 1rem}
        table{width:100%;border-collapse:collapse;font-size:0.875rem;min-width:800px}
        th,td{padding:0.75rem;text-align:left;border-bottom:1px solid var(--border)}
        th{background:#f1f5f9;font-weight:600;font-size:0.75rem;text-transform:uppercase;color:#64748b;white-space:nowrap}
        tr:hover{background:#f8fafc}
        .badge{padding:0.25rem 0.625rem;border-radius:9999px;font-size:0.75rem;font-weight:600}
        .badge-success{background:#d1fae5;color:#065f46}.badge-warning{background:#fef3c7;color:#92400e}.badge-danger{background:#fee2e2;color:#991b1b}.badge-info{background:#cffafe;color:#0e7490}
        .upload-zone{border:2px dashed var(--border);border-radius:0.5rem;padding:2rem;text-align:center;cursor:pointer;background:var(--bg);transition:all 0.2s}
        .upload-zone:hover,.upload-zone.dragover{border-color:var(--primary);background:#f0f9ff}
        .upload-icon{font-size:3rem;margin-bottom:0.5rem}
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;padding:1rem;backdrop-filter:blur(4px)}
        .modal.active{display:flex;align-items:center;justify-content:center}
        .modal-content{background:#fff;border-radius:1rem;max-width:600px;width:100%;max-height:90vh;overflow:hidden;box-shadow:0 25px 50px rgba(0,0,0,0.25)}
        .modal-content.large{max-width:900px}
        .modal-header{padding:1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-body{padding:1rem;overflow-y:auto;max-height:70vh}
        .modal-footer{padding:1rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:0.5rem;background:#f8fafc}
        .nota{font-family:'Courier New',monospace;font-size:12px;line-height:1.4;padding:1rem;background:#fff}
        .nota-header{text-align:center;border-bottom:2px solid #000;padding-bottom:0.5rem;margin-bottom:0.5rem}
        .nota-title{font-size:16px;font-weight:bold;margin-bottom:0.25rem}
        .nota-row{display:flex;justify-content:space-between;padding:0.125rem 0}
        .nota-total{font-size:14px;font-weight:bold;border-top:2px solid #000;margin-top:0.5rem;padding-top:0.5rem}
        .nota-signatures{display:flex;justify-content:space-between;margin-top:2rem;font-size:10px}
        .sign-box{text-align:center;width:40%}.sign-line{border-top:1px solid #000;margin-top:3rem;padding-top:0.25rem}
        .empty{text-align:center;padding:3rem;color:#64748b}
        .empty-icon{font-size:4rem;margin-bottom:1rem}
        .toast{position:fixed;bottom:1rem;right:1rem;background:#fff;padding:1rem 1.5rem;border-radius:0.5rem;box-shadow:0 10px 15px rgba(0,0,0,0.1);border-left:4px solid var(--success);z-index:10000;display:none;animation:toastIn 0.3s ease;min-width:300px}
        .toast.error{border-left-color:var(--danger)}.toast.warning{border-left-color:var(--warning)}
        @keyframes toastIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .offline{position:fixed;top:0;left:0;right:0;background:var(--warning);color:#fff;padding:0.5rem;text-align:center;z-index:9999;display:none;font-size:0.875rem;font-weight:500}
        .offline.show{display:block}
        .filter-bar{display:flex;gap:0.5rem;margin-bottom:1rem;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:0.5rem}
        .search-box{position:relative;flex:1;min-width:200px}
        .search-icon{position:absolute;left:0.75rem;top:50%;transform:translateY(-50%);color:#94a3b8}
        .search-box .form-input{padding-left:2.25rem}
        .action-btns{display:flex;gap:0.25rem}
        .recent-item{display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:#f8fafc;border-radius:0.5rem;margin-bottom:0.5rem;cursor:pointer;transition:all 0.2s}
        .recent-item:hover{background:#e2e8f0}
        .recent-icon{width:40px;height:40px;background:#fff;border-radius:0.5rem;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0}
        .recent-info{flex:1;min-width:0}
        .recent-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .recent-meta{font-size:0.75rem;color:#64748b}
        .loading{position:fixed;inset:0;background:rgba(255,255,255,0.9);z-index:9998;display:none;align-items:center;justify-content:center;flex-direction:column;gap:1rem}
        .loading.active{display:flex}
        .spinner{width:40px;height:40px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .pagination{display:flex;justify-content:center;gap:0.5rem;margin-top:1rem;flex-wrap:wrap}
        .page-btn{padding:0.375rem 0.75rem;border:1px solid var(--border);background:#fff;border-radius:0.375rem;cursor:pointer;min-width:36px}
        .page-btn:hover{border-color:var(--primary)}
        .page-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .page-btn:disabled{opacity:0.5;cursor:not-allowed}
        .settings-group{background:#f8fafc;border:1px solid var(--border);border-radius:0.5rem;padding:1rem;margin-bottom:1rem}
        .settings-title{font-size:0.875rem;font-weight:600;color:#64748b;margin-bottom:0.75rem;text-transform:uppercase}
        .checkbox-wrapper{display:flex;align-items:center;gap:0.5rem;cursor:pointer}
        .checkbox-wrapper input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
        
        /* Supplier specific styles */
        .supplier-card{background:#fff;border:1px solid var(--border);border-radius:0.5rem;padding:1rem;margin-bottom:0.75rem;transition:all 0.2s}
        .supplier-card:hover{box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .supplier-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:0.5rem}
        .supplier-name{font-weight:600;font-size:1rem;color:var(--text)}
        .supplier-bank{display:inline-block;background:var(--info);color:#fff;padding:0.25rem 0.5rem;border-radius:0.25rem;font-size:0.75rem;font-weight:500}
        .supplier-rek{font-family:monospace;font-size:0.875rem;color:#64748b;margin-top:0.25rem}
        .supplier-atasnama{font-size:0.875rem;color:var(--text);margin-top:0.25rem}
        .supplier-actions{display:flex;gap:0.5rem;margin-top:0.75rem}
        .supplier-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem}
        
        /* Laporan Keuangan styles */
        .laporan-header{background:linear-gradient(135deg,var(--success)0%,#059669 100%);color:#fff;padding:1.5rem;border-radius:0.75rem;margin-bottom:1rem}
        .laporan-title{font-size:1.25rem;font-weight:700;margin-bottom:0.25rem}
        .laporan-subtitle{font-size:0.875rem;opacity:0.9}
        .rekap-box{background:#fff;border:2px solid var(--success);border-radius:0.5rem;padding:1rem;margin-bottom:1rem}
        .rekap-title{font-size:0.875rem;color:#64748b;text-transform:uppercase;margin-bottom:0.5rem}
        .rekap-value{font-size:1.5rem;font-weight:700;color:var(--success)}
        .pembayaran-row{display:flex;justify-content:space-between;align-items:center;padding:0.75rem;border-bottom:1px solid var(--border)}
        .pembayaran-row:last-child{border-bottom:none}
        .pembayaran-info{flex:1}
        .pembayaran-nama{font-weight:600}
        .pembayaran-detail{font-size:0.875rem;color:#64748b}
        .pembayaran-jumlah{text-align:right;font-weight:700;color:var(--success)}
        .bank-info{background:#f0f9ff;border:1px solid #e0f2fe;border-radius:0.375rem;padding:0.5rem;margin-top:0.5rem;font-size:0.875rem}
        
        @media print{@page{size:80mm 297mm;margin:0}body *{visibility:hidden}.nota,.nota *{visibility:visible}.nota{position:absolute;left:0;top:0;width:80mm;padding:5mm}.no-print{display:none!important}.laporan-print{visibility:visible!important;position:absolute;left:0;top:0;width:100%;padding:20px}.laporan-print *{visibility:visible!important}}
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div style="color:#64748b;font-size:0.875rem">Memproses data...</div>
    </div>

    <!-- Offline Indicator -->
    <div class="offline" id="offline">üì° Anda sedang offline - Data tersimpan lokal</div>
    
    <!-- Toast -->
    <div class="toast" id="toast">
        <div style="font-weight:600;margin-bottom:0.25rem" id="toast-title">Berhasil</div>
        <div id="toast-msg">Operasi berhasil</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem">
                <div>
                    <h1 style="font-size:1.25rem;font-weight:700">‚öñÔ∏è Timbangan Gas Jaya</h1>
                    <p style="font-size:0.75rem;opacity:0.9">Sistem Pencatatan Online & Offline</p>
                </div>
                <div id="conn-status" style="font-size:0.75rem;padding:0.375rem 0.75rem;background:rgba(255,255,255,0.2);border-radius:9999px;display:flex;align-items:center;gap:0.5rem">
                    <span style="width:8px;height:8px;border-radius:50%;background:#10b981"></span>
                    <span>Online</span>
                </div>
            </div>
            
            <nav class="nav" id="main-nav">
                <button class="nav-btn active" onclick="app.switchTab('dashboard', this)" aria-label="Dashboard">
                    <span>üìä</span> Dashboard
                </button>
                <button class="nav-btn" onclick="app.switchTab('input', this)" aria-label="Input Transaksi">
                    <span>üìù</span> Input
                </button>
                <button class="nav-btn" onclick="app.switchTab('riwayat', this)" aria-label="Riwayat Transaksi">
                    <span>üìã</span> Riwayat
                </button>
                <button class="nav-btn" onclick="app.switchTab('supplier', this)" aria-label="Data Supplier">
                    <span>üè¢</span> Supplier
                </button>
                <button class="nav-btn" onclick="app.switchTab('laporan', this)" aria-label="Laporan Keuangan">
                    <span>üí∞</span> Laporan
                </button>
                <button class="nav-btn" onclick="app.switchTab('data', this)" aria-label="Manajemen Data">
                    <span>üíæ</span> Data
                </button>
                <button class="nav-btn" onclick="app.switchTab('pengaturan', this)" aria-label="Pengaturan">
                    <span>‚öôÔ∏è</span> Pengaturan
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        
        <!-- DASHBOARD -->
        <section id="dashboard" class="tab-content" style="display:block" aria-label="Dashboard">
            <div class="stats">
                <div class="stat">
                    <div style="font-size:0.75rem;color:#64748b;text-transform:uppercase">Total Transaksi</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
                <div class="stat success">
                    <div style="font-size:0.75rem;color:#64748b;text-transform:uppercase">Total Berat</div>
                    <div class="stat-value"><span id="stat-berat">0</span> <small style="font-size:0.75rem">kg</small></div>
                </div>
                <div class="stat warning">
                    <div style="font-size:0.75rem;color:#64748b;text-transform:uppercase">Total Nilai</div>
                    <div class="stat-value">Rp <span id="stat-nilai">0</span></div>
                </div>
                <div class="stat info">
                    <div style="font-size:0.75rem;color:#64748b;text-transform:uppercase">Total Supplier</div>
                    <div class="stat-value" id="stat-supplier">0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 style="font-size:1.125rem;font-weight:600;display:flex;align-items:center;gap:0.5rem">
                        <span>üïê</span> Transaksi Terbaru
                    </h2>
                    <button class="btn btn-outline btn-sm" onclick="app.switchTab('riwayat', document.querySelectorAll('.nav-btn')[2])">
                        Lihat Semua ‚Üí
                    </button>
                </div>
                <div class="card-body" id="recent-list">
                    <div class="empty">
                        <div class="empty-icon">üì≠</div>
                        <div style="font-weight:600;margin-bottom:0.5rem">Belum ada transaksi</div>
                        <p style="font-size:0.875rem">Mulai dengan menambahkan transaksi baru</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- INPUT -->
        <section id="input" class="tab-content" style="display:none" aria-label="Input Transaksi">
            <form id="form-transaksi" onsubmit="return app.saveTransaction(event)">
                <div class="card">
                    <div class="card-header">
                        <h2 style="font-size:1.125rem;font-weight:600;display:flex;align-items:center;gap:0.5rem">
                            <span>üìù</span> Input Timbangan Baru
                        </h2>
                        <button type="button" class="btn btn-outline btn-sm" onclick="app.resetForm()">
                            <span>‚Ü∫</span> Reset
                        </button>
                    </div>
                    
                    <div class="card-body">
                        <!-- Info Dasar -->
                        <div style="margin-bottom:1.5rem">
                            <h3 style="font-size:0.875rem;color:#64748b;text-transform:uppercase;margin-bottom:0.75rem">Informasi Dasar</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="inp-tanggal">Tanggal *</label>
                                    <input type="date" class="form-input" id="inp-tanggal" required aria-required="true">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="inp-jam">Jam *</label>
                                    <input type="time" class="form-input" id="inp-jam" required aria-required="true">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="inp-supir">Nama Supir *</label>
                                    <input type="text" class="form-input" id="inp-supir" list="list-supir" placeholder="Nama lengkap supir" required aria-required="true" maxlength="100">
                                    <datalist id="list-supir"></datalist>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="inp-plat">Plat Nomor *</label>
                                    <input type="text" class="form-input" id="inp-plat" list="list-plat" placeholder="B 1234 ABC" required aria-required="true" maxlength="20" style="text-transform:uppercase">
                                </div>
                                <div class="form-group span-2">
                                    <label class="form-label" for="inp-supplier">Nama Supplier *</label>
                                    <select class="form-select" id="inp-supplier" onchange="app.onSupplierChange()" required aria-required="true">
                                        <option value="">-- Pilih Supplier --</option>
                                    </select>
                                    <small style="color:#64748b;font-size:0.75rem;margin-top:0.25rem;display:block">
                                        <a href="#" onclick="app.switchTab('supplier', document.querySelectorAll('.nav-btn')[3]); return false;" style="color:var(--primary)">+ Tambah supplier baru</a>
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Info Rekening Supplier (Auto-fill) -->
                            <div id="supplier-info-display" style="display:none;margin-top:1rem;padding:1rem;background:#f0f9ff;border:1px solid #e0f2fe;border-radius:0.5rem">
                                <div style="font-size:0.875rem;color:#64748b;margin-bottom:0.5rem">Informasi Pembayaran:</div>
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:0.75rem">
                                    <div>
                                        <div style="font-size:0.75rem;color:#64748b">Bank</div>
                                        <div style="font-weight:600" id="disp-bank">-</div>
                                    </div>
                                    <div>
                                        <div style="font-size:0.75rem;color:#64748b">Atas Nama</div>
                                        <div style="font-weight:600" id="disp-atasnama">-</div>
                                    </div>
                                    <div>
                                        <div style="font-size:0.75rem;color:#64748b">No. Rekening</div>
                                        <div style="font-weight:600;font-family:monospace" id="disp-rekening">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Perhitungan Berat -->
                        <div style="margin-bottom:1.5rem">
                            <h3 style="font-size:0.875rem;color:#64748b;text-transform:uppercase;margin-bottom:0.75rem">‚öñÔ∏è Perhitungan Berat</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="inp-bruto">Berat Kotor (Bruto) *</label>
                                    <div class="input-group">
                                        <input type="number" class="form-input" id="inp-bruto" step="0.01" min="0" max="100000" placeholder="0" oninput="app.calculateWeight()" required aria-required="true">
                                        <span class="input-suffix">kg</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="inp-tara">Tara (Kendaraan) *</label>
                                    <div class="input-group">
                                        <input type="number" class="form-input" id="inp-tara" step="0.01" min="0" max="100000" placeholder="0" oninput="app.calculateWeight()" required aria-required="true">
                                        <span class="input-suffix">kg</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="inp-potongan">Potongan (%)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-input" id="inp-potongan" value="0" step="0.01" min="0" max="100" oninput="app.calculateWeight()" aria-label="Potongan persentase">
                                        <span class="input-suffix">%</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="inp-netto">Berat Bersih (Netto)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-input" id="inp-netto" readonly style="font-weight:700;color:var(--primary);font-size:1.125rem" aria-live="polite">
                                        <span class="input-suffix">kg</span>
                                    </div>
                                    <small id="netto-hint" style="color:#64748b;font-size:0.75rem;display:none">Dibulatkan kebawah (floor)</small>
                                </div>
                            </div>
                        </div>

                        <!-- Keuangan -->
                        <div style="margin-bottom:1.5rem">
                            <h3 style="font-size:0.875rem;color:#64748b;text-transform:uppercase;margin-bottom:0.75rem">üí∞ Detail Keuangan</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="inp-harga">Harga per kg *</label>
                                    <div class="input-group">
                                        <span class="input-prefix">Rp</span>
                                        <input type="number" class="form-input" id="inp-harga" step="1" min="0" max="1000000000" placeholder="0" oninput="app.calculateWeight()" required aria-required="true">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="inp-admin">Biaya Admin</label>
                                    <div class="input-group">
                                        <span class="input-prefix">Rp</span>
                                        <input type="number" class="form-input" id="inp-admin" value="0" step="1" min="0" max="100000000" oninput="app.calculateWeight()">
                                    </div>
                                </div>
                            </div>

                            <div class="calc-box">
                                <div class="calc-row">
                                    <span>Subtotal:</span>
                                    <span>Rp <span id="calc-subtotal">0</span></span>
                                </div>
                                <div class="calc-row">
                                    <span>Biaya Admin:</span>
                                    <span>Rp <span id="calc-admin">0</span></span>
                                </div>
                                <div class="calc-row">
                                    <span>Total Transfer:</span>
                                    <span>Rp <span id="calc-total">0</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Pembayaran -->
                        <div style="margin-bottom:1.5rem">
                            <h3 style="font-size:0.875rem;color:#64748b;text-transform:uppercase;margin-bottom:0.75rem">üí≥ Status Pembayaran</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="inp-status">Status *</label>
                                    <select class="form-select" id="inp-status" onchange="app.calculateWeight()" required aria-required="true">
                                        <option value="Lunas">‚úÖ Lunas</option>
                                        <option value="Dicicil">‚è≥ Dicicil</option>
                                        <option value="Belum Lunas">‚ùå Belum Lunas</option>
                                    </select>
                                </div>
                                <div class="form-group" id="group-dibayar" style="display:none">
                                    <label class="form-label" for="inp-dibayar">Jumlah Dibayar</label>
                                    <div class="input-group">
                                        <span class="input-prefix">Rp</span>
                                        <input type="number" class="form-input" id="inp-dibayar" step="1" min="0" max="10000000000" oninput="app.calculateWeight()">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="inp-sisa">Sisa/Terutang</label>
                                    <div class="input-group">
                                        <span class="input-prefix">Rp</span>
                                        <input type="text" class="form-input" id="inp-sisa" readonly aria-live="polite">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="display:flex;gap:0.75rem;flex-wrap:wrap">
                            <button type="submit" class="btn btn-primary btn-lg" style="flex:1;min-width:140px" id="btn-submit">
                                <span>üíæ</span> Simpan Transaksi
                            </button>
                            <button type="button" class="btn btn-outline btn-lg" onclick="app.resetForm()" style="flex:1;min-width:140px">
                                <span>‚úï</span> Batal
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </section>

        <!-- RIWAYAT -->
        <section id="riwayat" class="tab-content" style="display:none" aria-label="Riwayat Transaksi">
            <div class="card">
                <div class="card-header">
                    <h2 style="font-size:1.125rem;font-weight:600;display:flex;align-items:center;gap:0.5rem">
                        <span>üìã</span> Riwayat Transaksi
                    </h2>
                    <button class="btn btn-success btn-sm" onclick="app.exportCSV()">
                        <span>üì•</span> Export CSV
                    </button>
                </div>
                <div class="card-body">
                    <div class="filter-bar">
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" class="form-input" id="filter-search" placeholder="Cari supir, plat, supplier..." oninput="app.debounceRender()" aria-label="Pencarian">
                        </div>
                        <select class="form-select" id="filter-status" onchange="app.renderHistory()" style="width:130px;flex-shrink:0" aria-label="Filter status">
                            <option value="">Semua Status</option>
                            <option value="Lunas">‚úÖ Lunas</option>
                            <option value="Dicicil">‚è≥ Dicicil</option>
                            <option value="Belum Lunas">‚ùå Belum Lunas</option>
                        </select>
                        <input type="date" class="form-input" id="filter-tanggal" onchange="app.renderHistory()" style="width:140px;flex-shrink:0" aria-label="Filter tanggal">
                        <button class="btn btn-outline btn-sm" onclick="app.clearFilter()" style="flex-shrink:0" title="Reset filter">
                            <span>‚Ü∫</span>
                        </button>
                    </div>

                    <div class="table-container">
                        <table id="table-riwayat">
                            <thead>
                                <tr>
                                    <th scope="col">Tanggal</th>
                                    <th scope="col">Supir</th>
                                    <th scope="col">Plat</th>
                                    <th scope="col">Supplier</th>
                                    <th scope="col">Berat</th>
                                    <th scope="col">Total</th>
                                    <th scope="col">Status</th>
                                    <th scope="col" class="no-print">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-riwayat">
                                <tr>
                                    <td colspan="8" style="text-align:center;padding:3rem">
                                        <div class="empty">
                                            <div class="empty-icon">üì≠</div>
                                            <div style="font-weight:600">Belum ada transaksi</div>
                                            <p style="font-size:0.875rem">Data akan muncul di sini setelah Anda menyimpan transaksi</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="pagination"></div>
                </div>
            </div>
        </section>

        <!-- SUPPLIER DATABASE - FITUR BARU -->
        <section id="supplier" class="tab-content" style="display:none" aria-label="Data Supplier">
            <div class="card">
                <div class="card-header">
                    <h2 style="font-size:1.125rem;font-weight:600;display:flex;align-items:center;gap:0.5rem">
                        <span>üè¢</span> Database Supplier
                    </h2>
                    <button class="btn btn-primary btn-sm" onclick="app.openSupplierModal()">
                        <span>+</span> Tambah Supplier
                    </button>
                </div>
                <div class="card-body">
                    <div class="filter-bar">
                        <div class="search-box" style="flex:1;max-width:400px">
                            <span class="search-icon">üîç</span>
                            <input type="text" class="form-input" id="supplier-search" placeholder="Cari nama supplier, bank, atau rekening..." oninput="app.renderSupplierList()">
                        </div>
                    </div>
                    
                    <div id="supplier-list" class="supplier-grid">
                        <div class="empty" style="grid-column:1/-1">
                            <div class="empty-icon">üè¢</div>
                            <div style="font-weight:600;margin-bottom:0.5rem">Belum ada data supplier</div>
                            <p style="font-size:0.875rem">Tambahkan supplier untuk memudahkan input transaksi dan laporan pembayaran</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- LAPORAN KEUANGAN - FITUR BARU -->
        <section id="laporan" class="tab-content" style="display:none" aria-label="Laporan Keuangan">
            <div class="laporan-header no-print">
                <div class="laporan-title">üí∞ Laporan Pembayaran Supplier</div>
                <div class="laporan-subtitle">Ringkasan transaksi harian untuk bagian keuangan</div>
            </div>

            <div class="card no-print">
                <div class="card-header">
                    <h2 style="font-size:1.125rem;font-weight:600;display:flex;align-items:center;gap:0.5rem">
                        <span>üìÖ</span> Filter Periode
                    </h2>
                </div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Tanggal Mulai</label>
                            <input type="date" class="form-input" id="laporan-start" onchange="app.generateLaporan()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tanggal Selesai</label>
                            <input type="date" class="form-input" id="laporan-end" onchange="app.generateLaporan()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status Pembayaran</label>
                            <select class="form-select" id="laporan-status" onchange="app.generateLaporan()">
                                <option value="all">Semua Status</option>
                                <option value="Belum Lunas">Belum Lunas (Pending)</option>
                                <option value="Dicicil">Dicicil (Partial)</option>
                                <option value="Lunas">Lunas (Paid)</option>
                            </select>
                        </div>
                        <div class="form-group" style="display:flex;align-items:end">
                            <button class="btn btn-secondary" onclick="app.resetLaporanFilter()" style="width:100%">
                                <span>‚Ü∫</span> Reset Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="laporan-content" style="display:none">
                <div class="rekap-box no-print">
                    <div class="rekap-title">Total yang Harus Dibayarkan</div>
                    <div class="rekap-value" id="laporan-total">Rp 0</div>
                    <div style="margin-top:0.5rem;font-size:0.875rem;color:#64748b">
                        <span id="laporan-count">0</span> transaksi dari <span id="laporan-supplier-count">0</span> supplier
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" style="flex-wrap:wrap;gap:0.5rem">
                        <h2 style="font-size:1.125rem;font-weight:600;display:flex;align-items:center;gap:0.5rem">
                            <span>üìã</span> Detail Pembayaran per Supplier
                        </h2>
                        <div style="display:flex;gap:0.5rem">
                            <button class="btn btn-success btn-sm" onclick="app.exportLaporanCSV()">
                                <span>üì•</span> Export CSV
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="window.print()">
                                <span>üñ®Ô∏è</span> Cetak Laporan
                            </button>
                        </div>
                    </div>
                    <div class="card-body" id="laporan-detail">
                        <!-- Generated content -->
                    </div>
                </div>
            </div>

            <div id="laporan-empty" class="card" style="display:block">
                <div class="card-body" style="text-align:center;padding:3rem">
                    <div class="empty-icon">üìä</div>
                    <div style="font-weight:600;margin-bottom:0.5rem">Pilih periode untuk melihat laporan</div>
                    <p style="font-size:0.875rem;color:#64748b">Laporan akan menampilkan ringkasan pembayaran yang harus dilakukan ke masing-masing supplier</p>
                </div>
            </div>

            <!-- Printable Version -->
            <div id="laporan-printable" class="laporan-print" style="display:none">
                <div style="text-align:center;margin-bottom:2rem;border-bottom:2px solid #000;padding-bottom:1rem">
                    <h1 style="font-size:24px;margin-bottom:0.5rem">LAPORAN PEMBAYARAN SUPPLIER</h1>
                    <p style="font-size:14px;color:#666">Timbangan Gas Jaya</p>
                    <p style="font-size:12px;color:#666" id="print-periode">Periode: -</p>
                </div>
                <div id="print-content"></div>
            </div>
        </section>

        <!-- DATA -->
        <section id="data" class="tab-content" style="display:none" aria-label="Manajemen Data">
            <div class="card">
                <div class="card-header">
                    <h2 style="font-size:1.125rem;font-weight:600;display:flex;align-items:center;gap:0.5rem">
                        <span>üìÅ</span> Import Data CSV
                    </h2>
                </div>
                <div class="card-body">
                    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-csv').click()">
                        <div class="upload-icon">üì§</div>
                        <h3 style="font-size:1rem;margin-bottom:0.5rem">Upload File CSV</h3>
                        <p style="color:#64748b;font-size:0.875rem;margin-bottom:0.5rem">Tap untuk memilih file atau drag & drop di sini</p>
                        <p style="font-size:0.75rem;color:#94a3b8">Format: tanggal, jam, supir, plat, supplier, bruto, tara, potongan, harga, admin, status</p>
                    </div>
                    <input type="file" id="file-csv" accept=".csv" style="display:none" onchange="app.importCSV(this)" aria-label="Upload CSV">

                    <div id="preview-section" style="display:none;margin-top:1.5rem">
                        <h4 style="margin-bottom:0.75rem">Preview Data (<span id="preview-count">0</span> baris)</h4>
                        <div class="table-container">
                            <table id="table-preview" class="data-table">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div style="margin-top:1rem;display:flex;gap:0.5rem">
                            <button class="btn btn-primary" onclick="app.processImport()">
                                <span>‚úì</span> Import Data
                            </button>
                            <button class="btn btn-outline" onclick="app.cancelImport()">
                                <span>‚úï</span> Batal
                            </button>
                        </div>
                    </div>

                    <div style="margin-top:2rem;padding-top:2rem;border-top:2px solid var(--border)">
                        <h3 style="font-size:1rem;margin-bottom:0.5rem">üìÑ Download Template</h3>
                        <p style="color:#64748b;font-size:0.875rem;margin-bottom:1rem">Unduh template CSV untuk memastikan format data sesuai</p>
                        <button class="btn btn-secondary" onclick="app.downloadTemplate()">
                            <span>üì•</span> Download Template CSV
                        </button>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:1rem">
                <div class="card-header">
                    <h2 style="font-size:1.125rem;font-weight:600;display:flex;align-items:center;gap:0.5rem">
                        <span>üíæ</span> Backup & Restore
                    </h2>
                </div>
                <div class="card-body">
                    <div style="display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(250px,1fr))">
                        <div style="text-align:center;padding:1.5rem;background:#f8fafc;border-radius:0.5rem;border:1px solid var(--border)">
                            <div style="font-size:3rem;margin-bottom:0.5rem">üíæ</div>
                            <h4 style="margin-bottom:0.5rem">Backup Data</h4>
                            <p style="font-size:0.875rem;color:#64748b;margin-bottom:1rem">Simpan semua data dalam format JSON</p>
                            <button class="btn btn-success" onclick="app.backupJSON()">
                                <span>üì•</span> Backup JSON
                            </button>
                        </div>
                        
                        <div style="text-align:center;padding:1.5rem;background:#f8fafc;border-radius:0.5rem;border:1px solid var(--border)">
                            <div style="font-size:3rem;margin-bottom:0.5rem">üîÑ</div>
                            <h4 style="margin-bottom:0.5rem">Restore Data</h4>
                            <p style="font-size:0.875rem;color:#64748b;margin-bottom:1rem">Pulihkan data dari file backup JSON</p>
                            <input type="file" id="file-restore" accept=".json" style="display:none" onchange="app.restoreJSON(this)" aria-label="Restore JSON">
                            <button class="btn btn-warning" onclick="document.getElementById('file-restore').click()">
                                <span>üì§</span> Restore JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PENGATURAN -->
        <section id="pengaturan" class="tab-content" style="display:none" aria-label="Pengaturan">
            <div class="card">
                <div class="card-header">
                    <h2 style="font-size:1.125rem;font-weight:600;display:flex;align-items:center;gap:0.5rem">
                        <span>‚öôÔ∏è</span> Pengaturan Nota & Perhitungan
                    </h2>
                </div>
                <div class="card-body">
                    <!-- Pengaturan Alamat -->
                    <div class="settings-group">
                        <div class="settings-title">üìç Informasi Timbangan</div>
                        <div class="form-grid">
                            <div class="form-group span-2">
                                <label class="form-label" for="setting-nama">Nama Perusahaan</label>
                                <input type="text" class="form-input" id="setting-nama" placeholder="Timbangan Gas Jaya" maxlength="100">
                            </div>
                            <div class="form-group span-2">
                                <label class="form-label" for="setting-alamat">Alamat Lengkap</label>
                                <textarea class="form-input" id="setting-alamat" rows="2" placeholder="Jl. Industri No. 123, Jakarta" maxlength="200" style="resize:vertical;min-height:60px"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="setting-telepon">Telepon</label>
                                <input type="text" class="form-input" id="setting-telepon" placeholder="021-1234567" maxlength="20">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="setting-kota">Kota</label>
                                <input type="text" class="form-input" id="setting-kota" placeholder="Jakarta" maxlength="50">
                            </div>
                        </div>
                    </div>

                    <!-- Pengaturan Perhitungan -->
                    <div class="settings-group">
                        <div class="settings-title">‚öñÔ∏è Pengaturan Perhitungan</div>
                        <div class="form-group" style="margin-bottom:1rem">
                            <label class="checkbox-wrapper">
                                <input type="checkbox" id="setting-floor" onchange="app.toggleFloorSetting()">
                                <span>Pembulatan Berat Bersih ke Bawah (Floor)</span>
                            </label>
                            <p style="font-size:0.75rem;color:#64748b;margin-left:26px;margin-top:0.25rem">
                                Jika diaktifkan: 1234.99 kg ‚Üí 1234 kg (tanpa desimal)
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="setting-desimal">Jumlah Desimal Netto (jika floor tidak aktif)</label>
                            <select class="form-select" id="setting-desimal" style="width:150px">
                                <option value="2">2 desimal (1.23)</option>
                                <option value="1">1 desimal (1.2)</option>
                                <option value="0">0 desimal (1)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Preview Nota -->
                    <div class="settings-group">
                        <div class="settings-title">üëÅÔ∏è Preview Nota</div>
                        <div id="preview-nota-settings" style="background:#f8fafc;border:1px solid var(--border);border-radius:0.5rem;padding:1rem;font-family:'Courier New',monospace;font-size:12px;line-height:1.4">
                            <div style="text-align:center;border-bottom:2px solid #000;padding-bottom:0.5rem;margin-bottom:0.5rem">
                                <div style="font-size:16px;font-weight:bold" id="preview-nama">TIMBANGAN GAS JAYA</div>
                                <div style="font-size:10px" id="preview-alamat">Jl. Industri No. 123, Jakarta</div>
                                <div style="font-size:10px" id="preview-telepon">Telp: 021-1234567</div>
                            </div>
                            <div style="color:#666;text-align:center;font-size:10px">[Preview header nota]</div>
                        </div>
                    </div>

                    <div style="display:flex;gap:0.75rem;margin-top:1.5rem">
                        <button class="btn btn-primary btn-lg" onclick="app.saveSettings()" style="flex:1">
                            <span>üíæ</span> Simpan Pengaturan
                        </button>
                        <button class="btn btn-outline btn-lg" onclick="app.resetSettings()" style="flex:1">
                            <span>‚Ü∫</span> Reset Default
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Nota -->
    <div class="modal" id="modal-nota" onclick="if(event.target===this)app.closeNota()" role="dialog" aria-modal="true" aria-labelledby="nota-title">
        <div class="modal-content">
            <div class="modal-header no-print">
                <h3 style="display:flex;align-items:center;gap:0.5rem" id="nota-title">
                    <span>üßæ</span> Preview Nota
                </h3>
                <button class="btn btn-outline btn-sm" onclick="app.closeNota()" aria-label="Tutup">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="nota-content" class="nota">
                    <div class="nota-header">
                        <div class="nota-title" id="nota-nama-perusahaan">TIMBANGAN GAS JAYA</div>
                        <div style="font-size:10px" id="nota-alamat">Jl. Industri No. 123, Jakarta</div>
                        <div style="font-size:10px" id="nota-telepon">Telp: 021-1234567</div>
                    </div>
                    
                    <div class="nota-row"><span>No:</span><span id="nota-no">-</span></div>
                    <div class="nota-row"><span>Tanggal:</span><span id="nota-tanggal">-</span></div>
                    <div class="nota-row"><span>Supir:</span><span id="nota-supir">-</span></div>
                    <div class="nota-row"><span>Plat:</span><span id="nota-plat">-</span></div>
                    <div class="nota-row"><span>Supplier:</span><span id="nota-supplier">-</span></div>
                    
                    <div style="border-top:1px dashed #000;border-bottom:1px dashed #000;margin:0.5rem 0;padding:0.5rem 0">
                        <div class="nota-row"><span>Bruto:</span><span id="nota-bruto">-</span></div>
                        <div class="nota-row"><span>Tara:</span><span id="nota-tara">-</span></div>
                        <div class="nota-row"><span>Potongan:</span><span id="nota-potongan">-</span></div>
                        <div class="nota-row" style="font-weight:bold"><span>Netto:</span><span id="nota-netto">-</span></div>
                    </div>
                    
                    <div class="nota-row"><span>Harga/kg:</span><span id="nota-harga">-</span></div>
                    <div class="nota-total"><span>TOTAL:</span><span id="nota-total">-</span></div>
                    <div class="nota-row"><span>Status:</span><span id="nota-status">-</span></div>
                    
                    <div class="nota-signatures">
                        <div class="sign-box">
                            <div class="sign-line">Operator</div>
                        </div>
                        <div class="sign-box">
                            <div class="sign-line">Supir</div>
                        </div>
                    </div>
                    
                    <div style="text-align:center;margin-top:1rem;font-size:9px;color:#666">
                        Terima kasih atas kepercayaan Anda<br>
                        <small>Nota ini sah tanpa tanda tangan basah</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer no-print">
                <button class="btn btn-outline" onclick="app.closeNota()">Tutup</button>
                <button class="btn btn-primary" onclick="window.print()">
                    <span>üñ®Ô∏è</span> Cetak Nota
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Supplier - FITUR BARU -->
    <div class="modal" id="modal-supplier" onclick="if(event.target===this)app.closeSupplierModal()" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="display:flex;align-items:center;gap:0.5rem">
                    <span>üè¢</span> <span id="supplier-modal-title">Tambah Supplier</span>
                </h3>
                <button class="btn btn-outline btn-sm" onclick="app.closeSupplierModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="form-supplier" onsubmit="return app.saveSupplier(event)">
                    <input type="hidden" id="supplier-id">
                    <div class="form-grid">
                        <div class="form-group span-2">
                            <label class="form-label" for="supplier-nama">Nama Supplier *</label>
                            <input type="text" class="form-input" id="supplier-nama" required maxlength="100" placeholder="PT Gas Makmur">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="supplier-bank">Nama Bank *</label>
                            <select class="form-select" id="supplier-bank" required>
                                <option value="">Pilih Bank</option>
                                <option value="BCA">BCA</option>
                                <option value="Mandiri">Mandiri</option>
                                <option value="BNI">BNI</option>
                                <option value="BRI">BRI</option>
                                <option value="BSI">BSI</option>
                                <option value="CIMB">CIMB Niaga</option>
                                <option value="Danamon">Danamon</option>
                                <option value="Permata">Permata</option>
                                <option value="Maybank">Maybank</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="supplier-rekening">Nomor Rekening *</label>
                            <input type="text" class="form-input" id="supplier-rekening" required maxlength="30" placeholder="1234567890">
                        </div>
                        <div class="form-group span-2">
                            <label class="form-label" for="supplier-atasnama">Atas Nama Rekening *</label>
                            <input type="text" class="form-input" id="supplier-atasnama" required maxlength="100" placeholder="Nama lengkap pemilik rekening">
                        </div>
                        <div class="form-group span-2">
                            <label class="form-label" for="supplier-keterangan">Keterangan (Opsional)</label>
                            <textarea class="form-input" id="supplier-keterangan" rows="2" maxlength="200" placeholder="Alamat, kontak, atau catatan lain"></textarea>
                        </div>
                    </div>
                    <div style="display:flex;gap:0.75rem;margin-top:1.5rem">
                        <button type="submit" class="btn btn-primary" style="flex:1">
                            <span>üíæ</span> Simpan
                        </button>
                        <button type="button" class="btn btn-outline" onclick="app.closeSupplierModal()" style="flex:1">
                            <span>‚úï</span> Batal
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        /**
         * Timbangan Gas Jaya - Version 3.0
         * Features: Supplier Database, Financial Reports, Edit Transaction
         */
        
        const app = (function() {
            'use strict';
            
            // ==========================================
            // CONSTANTS & CONFIG
            // ==========================================
            const CONFIG = {
                STORAGE_KEY: 'gasjaya_data_v3',
                STORAGE_SUPPLIER: 'gasjaya_suppliers_v3',
                STORAGE_SETTINGS: 'gasjaya_settings_v3',
                STORAGE_META: 'gasjaya_meta_v3',
                MAX_TRANSACTIONS: 5000,
                MAX_SUPPLIERS: 200,
                ITEMS_PER_PAGE: 50,
                MAX_INPUT_LENGTH: 100,
                DEBOUNCE_DELAY: 300,
                VERSION: '3.0.0'
            };

            const DEFAULT_SETTINGS = {
                namaPerusahaan: 'TIMBANGAN GAS JAYA',
                alamat: 'Jl. Industri No. 123, Jakarta',
                telepon: '021-1234567',
                kota: 'Jakarta',
                useFloor: false,
                decimalPlaces: 2
            };

            // ==========================================
            // STATE MANAGEMENT
            // ==========================================
            let state = {
                transactions: [],
                suppliers: [], // FITUR BARU: Database supplier
                currentImport: [],
                editingId: null,
                editingSupplierId: null, // FITUR BARU
                currentPage: 1,
                isProcessing: false,
                settings: { ...DEFAULT_SETTINGS }
            };

            // ==========================================
            // UTILITY FUNCTIONS
            // ==========================================
            const utils = {
                generateId: (() => {
                    let counter = 0;
                    return () => {
                        const timestamp = Date.now();
                        const random = Math.floor(Math.random() * 10000);
                        counter = (counter + 1) % 10000;
                        return `${timestamp}-${random}-${counter}`;
                    };
                })(),

                formatRupiah: (num) => {
                    if (num === null || num === undefined || isNaN(num)) return '0';
                    return new Intl.NumberFormat('id-ID').format(Math.floor(num));
                },

                formatDate: (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const d = new Date(dateStr);
                        if (isNaN(d.getTime())) return '-';
                        return d.toLocaleDateString('id-ID', { 
                            day: '2-digit', 
                            month: 'short', 
                            year: 'numeric' 
                        });
                    } catch (e) {
                        return '-';
                    }
                },

                escapeHtml: (text) => {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = String(text);
                    return div.innerHTML;
                },

                sanitizeInput: (text, maxLength = CONFIG.MAX_INPUT_LENGTH) => {
                    if (!text) return '';
                    return String(text).trim().slice(0, maxLength);
                },

                validateNumber: (value, min = 0, max = Infinity, decimals = 2) => {
                    const num = parseFloat(value);
                    if (isNaN(num)) return min;
                    if (num < min) return min;
                    if (num > max) return max;
                    return Number(num.toFixed(decimals));
                },

                floorNumber: (value) => {
                    return Math.floor(parseFloat(value) || 0);
                },

                formatNetto: (value, useFloor, decimalPlaces) => {
                    if (useFloor) {
                        return Math.floor(value).toString();
                    }
                    return value.toFixed(decimalPlaces);
                },

                debounce: (func, wait) => {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                },

                calculateChecksum: (data) => {
                    const str = JSON.stringify(data);
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        const char = str.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    return Math.abs(hash).toString(16).slice(0, 8);
                },

                // FITUR BARU: Format nomor rekening
                formatRekening: (rek) => {
                    if (!rek) return '-';
                    return String(rek).replace(/(\d{4})(?=\d)/g, '$1-');
                }
            };

            // ==========================================
            // STORAGE MANAGEMENT
            // ==========================================
            const storage = {
                save: () => {
                    try {
                        const dataStr = JSON.stringify(state.transactions);
                        const sizeInMB = (dataStr.length * 2) / (1024 * 1024);
                        
                        if (sizeInMB > 4.5) {
                            ui.showToast('Storage hampir penuh! Silakan backup dan hapus data lama.', 'warning');
                            return false;
                        }

                        const payload = {
                            data: state.transactions,
                            checksum: utils.calculateChecksum(state.transactions),
                            version: CONFIG.VERSION,
                            timestamp: new Date().toISOString(),
                            count: state.transactions.length
                        };

                        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(payload));
                        localStorage.setItem(CONFIG.STORAGE_META, JSON.stringify({
                            lastUpdate: new Date().toISOString(),
                            count: state.transactions.length
                        }));

                        return true;
                    } catch (e) {
                        console.error('Storage save error:', e);
                        if (e.name === 'QuotaExceededError') {
                            ui.showToast('Storage penuh! Hapus data lama atau backup.', 'error');
                        } else {
                            ui.showToast('Gagal menyimpan data: ' + e.message, 'error');
                        }
                        return false;
                    }
                },

                load: () => {
                    try {
                        const stored = localStorage.getItem(CONFIG.STORAGE_KEY);
                        if (!stored) {
                            state.transactions = [];
                            return;
                        }

                        const payload = JSON.parse(stored);
                        
                        if (!payload || !Array.isArray(payload.data)) {
                            throw new Error('Format data tidak valid');
                        }

                        if (payload.checksum) {
                            const currentChecksum = utils.calculateChecksum(payload.data);
                            if (currentChecksum !== payload.checksum) {
                                console.warn('Checksum mismatch - data mungkin korup');
                            }
                        }

                        state.transactions = payload.data;
                        console.log(`Loaded ${state.transactions.length} transactions (v${payload.version || 'unknown'})`);
                        
                    } catch (e) {
                        console.error('Storage load error:', e);
                        ui.showToast('Error memuat data: ' + e.message, 'error');
                        state.transactions = [];
                    }
                },

                // FITUR BARU: Storage untuk supplier
                saveSuppliers: () => {
                    try {
                        localStorage.setItem(CONFIG.STORAGE_SUPPLIER, JSON.stringify({
                            data: state.suppliers,
                            version: CONFIG.VERSION,
                            timestamp: new Date().toISOString()
                        }));
                        return true;
                    } catch (e) {
                        console.error('Supplier save error:', e);
                        return false;
                    }
                },

                loadSuppliers: () => {
                    try {
                        const stored = localStorage.getItem(CONFIG.STORAGE_SUPPLIER);
                        if (stored) {
                            const payload = JSON.parse(stored);
                            if (payload && Array.isArray(payload.data)) {
                                state.suppliers = payload.data;
                                console.log(`Loaded ${state.suppliers.length} suppliers`);
                            }
                        }
                    } catch (e) {
                        console.error('Supplier load error:', e);
                        state.suppliers = [];
                    }
                },

                saveSettings: () => {
                    try {
                        localStorage.setItem(CONFIG.STORAGE_SETTINGS, JSON.stringify(state.settings));
                        return true;
                    } catch (e) {
                        console.error('Settings save error:', e);
                        return false;
                    }
                },

                loadSettings: () => {
                    try {
                        const stored = localStorage.getItem(CONFIG.STORAGE_SETTINGS);
                        if (stored) {
                            const loaded = JSON.parse(stored);
                            state.settings = { ...DEFAULT_SETTINGS, ...loaded };
                        }
                    } catch (e) {
                        console.error('Settings load error:', e);
                        state.settings = { ...DEFAULT_SETTINGS };
                    }
                },

                getUsage: () => {
                    try {
                        let total = 0;
                        for (let key in localStorage) {
                            if (localStorage.hasOwnProperty(key)) {
                                total += localStorage[key].length * 2;
                            }
                        }
                        return (total / (1024 * 1024)).toFixed(2) + ' MB';
                    } catch (e) {
                        return 'unknown';
                    }
                }
            };

            // ==========================================
            // UI FUNCTIONS
            // ==========================================
            const ui = {
                showToast: (message, type = 'success', duration = 3000) => {
                    const toast = document.getElementById('toast');
                    const title = document.getElementById('toast-title');
                    const msg = document.getElementById('toast-msg');
                    
                    const titles = { 
                        success: '‚úÖ Berhasil', 
                        error: '‚ùå Error', 
                        warning: '‚ö†Ô∏è Perhatian',
                        info: '‚ÑπÔ∏è Info'
                    };
                    
                    toast.className = 'toast show ' + type;
                    title.textContent = titles[type] || 'Info';
                    msg.textContent = message;
                    
                    setTimeout(() => {
                        toast.classList.remove('show');
                    }, duration);
                },

                setLoading: (show) => {
                    const el = document.getElementById('loading');
                    if (show) el.classList.add('active');
                    else el.classList.remove('active');
                    state.isProcessing = show;
                },

                updateConnectionStatus: () => {
                    const isOnline = navigator.onLine;
                    const statusEl = document.getElementById('conn-status');
                    const offlineEl = document.getElementById('offline');
                    
                    if (isOnline) {
                        statusEl.innerHTML = '<span style="width:8px;height:8px;border-radius:50%;background:#10b981"></span><span>Online</span>';
                        offlineEl.classList.remove('show');
                    } else {
                        statusEl.innerHTML = '<span style="width:8px;height:8px;border-radius:50%;background:#f59e0b"></span><span>Offline</span>';
                        offlineEl.classList.add('show');
                    }
                }
            };

            // ==========================================
            // VALIDATION
            // ==========================================
            const validator = {
                validateTransaction: (t) => {
                    const errors = [];
                    
                    if (!t.tanggal || !/^\d{4}-\d{2}-\d{2}$/.test(t.tanggal)) {
                        errors.push('Tanggal tidak valid');
                    }
                    
                    if (!t.jam || !/^\d{2}:\d{2}$/.test(t.jam)) {
                        errors.push('Jam tidak valid');
                    }
                    
                    if (!t.supir || t.supir.length < 2) {
                        errors.push('Nama supir minimal 2 karakter');
                    }
                    
                    if (!t.plat || t.plat.length < 3) {
                        errors.push('Plat nomor tidak valid');
                    }
                    
                    if (!t.supplier || t.supplier.length < 2) {
                        errors.push('Nama supplier minimal 2 karakter');
                    }
                    
                    if (t.bruto <= 0) {
                        errors.push('Berat bruto harus lebih dari 0');
                    }
                    
                    if (t.tara < 0 || t.tara >= t.bruto) {
                        errors.push('Tara harus lebih kecil dari bruto');
                    }
                    
                    if (t.harga <= 0) {
                        errors.push('Harga harus lebih dari 0');
                    }
                    
                    if (t.potonganPersen < 0 || t.potonganPersen > 100) {
                        errors.push('Potongan harus 0-100%');
                    }
                    
                    return {
                        isValid: errors.length === 0,
                        errors: errors
                    };
                },

                // FITUR BARU: Validasi supplier
                validateSupplier: (s) => {
                    const errors = [];
                    
                    if (!s.nama || s.nama.length < 2) {
                        errors.push('Nama supplier minimal 2 karakter');
                    }
                    
                    if (!s.bank) {
                        errors.push('Pilih bank');
                    }
                    
                    if (!s.rekening || s.rekening.length < 5) {
                        errors.push('Nomor rekening tidak valid');
                    }
                    
                    if (!s.atasNama || s.atasNama.length < 2) {
                        errors.push('Atas nama rekening harus diisi');
                    }
                    
                    return {
                        isValid: errors.length === 0,
                        errors: errors
                    };
                }
            };

            // ==========================================
            // CORE FUNCTIONS
            // ==========================================
            
            const init = () => {
                console.log(`Gas Jaya App v${CONFIG.VERSION} Loaded`);
                
                storage.load();
                storage.loadSuppliers(); // FITUR BARU
                storage.loadSettings();
                initDateTime();
                updateStats();
                renderRecent();
                renderHistory();
                updateDatalists();
                populateSupplierSelect(); // FITUR BARU
                initOnlineDetection();
                initDragDrop();
                loadSettingsToForm();
                initSettingsListeners();
                initLaporanDates(); // FITUR BARU
                
                setInterval(() => {
                    const usage = storage.getUsage();
                    if (parseFloat(usage) > 4) {
                        console.warn('Storage usage:', usage);
                    }
                }, 60000);
            };

            const initDateTime = () => {
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().slice(0, 5);
                
                const dateInput = document.getElementById('inp-tanggal');
                const timeInput = document.getElementById('inp-jam');
                
                if (dateInput) dateInput.value = dateStr;
                if (timeInput) timeInput.value = timeStr;
            };

            // FITUR BARU: Inisialisasi tanggal laporan
            const initLaporanDates = () => {
                const today = new Date().toISOString().split('T')[0];
                const startOfMonth = new Date();
                startOfMonth.setDate(1);
                
                document.getElementById('laporan-start').value = startOfMonth.toISOString().split('T')[0];
                document.getElementById('laporan-end').value = today;
            };

            const switchTab = (tabName, clickedBtn) => {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.style.display = 'none';
                    tab.setAttribute('aria-hidden', 'true');
                });
                
                const selected = document.getElementById(tabName);
                if (selected) {
                    selected.style.display = 'block';
                    selected.setAttribute('aria-hidden', 'false');
                }
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-current', 'false');
                });
                
                if (clickedBtn) {
                    clickedBtn.classList.add('active');
                    clickedBtn.setAttribute('aria-current', 'page');
                }
                
                if (tabName === 'riwayat') {
                    state.currentPage = 1;
                    renderHistory();
                } else if (tabName === 'dashboard') {
                    updateStats();
                    renderRecent();
                } else if (tabName === 'pengaturan') {
                    loadSettingsToForm();
                } else if (tabName === 'supplier') { // FITUR BARU
                    renderSupplierList();
                } else if (tabName === 'laporan') { // FITUR BARU
                    generateLaporan();
                }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            // ==========================================
            // SUPPLIER DATABASE FUNCTIONS - FITUR BARU
            // ==========================================
            
            const populateSupplierSelect = () => {
                const select = document.getElementById('inp-supplier');
                if (!select) return;
                
                // Simpan value yang sedang dipilih
                const currentValue = select.value;
                
                // Reset options
                select.innerHTML = '<option value="">-- Pilih Supplier --</option>';
                
                // Urutkan supplier berdasarkan nama
                const sortedSuppliers = [...state.suppliers].sort((a, b) => 
                    a.nama.localeCompare(b.nama)
                );
                
                sortedSuppliers.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.nama;
                    option.textContent = s.nama;
                    option.dataset.id = s.id;
                    select.appendChild(option);
                });
                
                // Restore value jika masih ada
                if (currentValue) {
                    select.value = currentValue;
                }
            };

            const onSupplierChange = () => {
                const select = document.getElementById('inp-supplier');
                const selectedName = select.value;
                const infoDisplay = document.getElementById('supplier-info-display');
                
                if (!selectedName) {
                    infoDisplay.style.display = 'none';
                    return;
                }
                
                const supplier = state.suppliers.find(s => s.nama === selectedName);
                if (supplier) {
                    document.getElementById('disp-bank').textContent = supplier.bank;
                    document.getElementById('disp-atasnama').textContent = supplier.atasNama;
                    document.getElementById('disp-rekening').textContent = utils.formatRekening(supplier.rekening);
                    infoDisplay.style.display = 'block';
                } else {
                    infoDisplay.style.display = 'none';
                }
            };

            const openSupplierModal = (id = null) => {
                const modal = document.getElementById('modal-supplier');
                const title = document.getElementById('supplier-modal-title');
                const form = document.getElementById('form-supplier');
                
                if (id) {
                    // Edit mode
                    const s = state.suppliers.find(x => x.id === id);
                    if (!s) return;
                    
                    state.editingSupplierId = id;
                    title.textContent = 'Edit Supplier';
                    document.getElementById('supplier-id').value = s.id;
                    document.getElementById('supplier-nama').value = s.nama;
                    document.getElementById('supplier-bank').value = s.bank;
                    document.getElementById('supplier-rekening').value = s.rekening;
                    document.getElementById('supplier-atasnama').value = s.atasNama;
                    document.getElementById('supplier-keterangan').value = s.keterangan || '';
                } else {
                    // Add mode
                    state.editingSupplierId = null;
                    title.textContent = 'Tambah Supplier';
                    form.reset();
                    document.getElementById('supplier-id').value = '';
                }
                
                modal.classList.add('active');
            };

            const closeSupplierModal = () => {
                document.getElementById('modal-supplier').classList.remove('active');
                state.editingSupplierId = null;
            };

            const saveSupplier = (e) => {
                e.preventDefault();
                
                if (state.suppliers.length >= CONFIG.MAX_SUPPLIERS && !state.editingSupplierId) {
                    ui.showToast(`Batas maksimal ${CONFIG.MAX_SUPPLIERS} supplier tercapai`, 'error');
                    return false;
                }
                
                const nama = utils.sanitizeInput(document.getElementById('supplier-nama').value, 100);
                const bank = document.getElementById('supplier-bank').value;
                const rekening = utils.sanitizeInput(document.getElementById('supplier-rekening').value, 30);
                const atasNama = utils.sanitizeInput(document.getElementById('supplier-atasnama').value, 100);
                const keterangan = utils.sanitizeInput(document.getElementById('supplier-keterangan').value, 200);
                
                // Cek duplikat nama (kecuali saat edit nama yang sama)
                const existing = state.suppliers.find(s => 
                    s.nama.toLowerCase() === nama.toLowerCase() && s.id !== state.editingSupplierId
                );
                if (existing) {
                    ui.showToast('Nama supplier sudah ada', 'error');
                    return false;
                }
                
                const supplier = {
                    id: state.editingSupplierId || utils.generateId(),
                    nama,
                    bank,
                    rekening,
                    atasNama,
                    keterangan,
                    createdAt: state.editingSupplierId 
                        ? state.suppliers.find(s => s.id === state.editingSupplierId)?.createdAt 
                        : new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                const validation = validator.validateSupplier(supplier);
                if (!validation.isValid) {
                    ui.showToast(validation.errors.join(', '), 'error');
                    return false;
                }
                
                if (state.editingSupplierId) {
                    const idx = state.suppliers.findIndex(s => s.id === state.editingSupplierId);
                    if (idx !== -1) {
                        state.suppliers[idx] = supplier;
                        ui.showToast('Supplier berhasil diupdate!', 'success');
                    }
                } else {
                    state.suppliers.push(supplier);
                    ui.showToast('Supplier berhasil ditambahkan!', 'success');
                }
                
                if (storage.saveSuppliers()) {
                    renderSupplierList();
                    populateSupplierSelect();
                    closeSupplierModal();
                }
                
                return false;
            };

            const renderSupplierList = () => {
                const container = document.getElementById('supplier-list');
                const search = utils.sanitizeInput(document.getElementById('supplier-search')?.value || '').toLowerCase();
                
                let filtered = state.suppliers;
                if (search) {
                    filtered = state.suppliers.filter(s => 
                        s.nama.toLowerCase().includes(search) ||
                        s.bank.toLowerCase().includes(search) ||
                        s.rekening.includes(search) ||
                        s.atasNama.toLowerCase().includes(search)
                    );
                }
                
                // Urutkan berdasarkan nama
                filtered.sort((a, b) => a.nama.localeCompare(b.nama));
                
                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div class="empty" style="grid-column:1/-1">
                            <div class="empty-icon">üè¢</div>
                            <div style="font-weight:600;margin-bottom:0.5rem">${search ? 'Tidak ada hasil pencarian' : 'Belum ada data supplier'}</div>
                            <p style="font-size:0.875rem">${search ? 'Coba kata kunci lain' : 'Tambahkan supplier untuk memudahkan input transaksi'}</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = filtered.map(s => `
                    <div class="supplier-card">
                        <div class="supplier-header">
                            <div>
                                <div class="supplier-name">${utils.escapeHtml(s.nama)}</div>
                                <span class="supplier-bank">${utils.escapeHtml(s.bank)}</span>
                            </div>
                        </div>
                        <div class="supplier-atasnama">
                            <strong>${utils.escapeHtml(s.atasNama)}</strong>
                        </div>
                        <div class="supplier-rek">
                            Rek: ${utils.formatRekening(s.rekening)}
                        </div>
                        ${s.keterangan ? `<div style="margin-top:0.5rem;font-size:0.875rem;color:#64748b">${utils.escapeHtml(s.keterangan)}</div>` : ''}
                        <div class="supplier-actions">
                            <button class="btn btn-warning btn-sm" onclick="app.openSupplierModal('${s.id}')">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="app.deleteSupplier('${s.id}')">
                                üóëÔ∏è Hapus
                            </button>
                        </div>
                    </div>
                `).join('');
            };

            const deleteSupplier = (id) => {
                const s = state.suppliers.find(x => x.id === id);
                if (!s) return;
                
                // Cek apakah supplier digunakan di transaksi
                const usedInTransaksi = state.transactions.some(t => t.supplier === s.nama);
                if (usedInTransaksi) {
                    if (!confirm('Supplier ini digunakan di beberapa transaksi. Menghapus akan membuat data transaksi tetap tersimpan tapi tanpa kaitan supplier. Lanjutkan?')) {
                        return;
                    }
                } else {
                    if (!confirm('Yakin ingin menghapus supplier ini?')) return;
                }
                
                state.suppliers = state.suppliers.filter(s => s.id !== id);
                
                if (storage.saveSuppliers()) {
                    renderSupplierList();
                    populateSupplierSelect();
                    ui.showToast('Supplier berhasil dihapus', 'success');
                }
            };

            // ==========================================
            // LAPORAN KEUANGAN FUNCTIONS - FITUR BARU
            // ==========================================
            
            const generateLaporan = () => {
                const startDate = document.getElementById('laporan-start').value;
                const endDate = document.getElementById('laporan-end').value;
                const statusFilter = document.getElementById('laporan-status').value;
                
                if (!startDate || !endDate) {
                    document.getElementById('laporan-content').style.display = 'none';
                    document.getElementById('laporan-empty').style.display = 'block';
                    return;
                }
                
                // Filter transaksi
                let filtered = state.transactions.filter(t => {
                    const tDate = new Date(t.tanggal);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59);
                    
                    const inRange = tDate >= start && tDate <= end;
                    const matchStatus = statusFilter === 'all' || t.status === statusFilter;
                    
                    return inRange && matchStatus;
                });
                
                if (filtered.length === 0) {
                    document.getElementById('laporan-content').style.display = 'none';
                    document.getElementById('laporan-empty').style.display = 'block';
                    document.getElementById('laporan-empty').innerHTML = `
                        <div class="card-body" style="text-align:center;padding:3rem">
                            <div class="empty-icon">üìä</div>
                            <div style="font-weight:600;margin-bottom:0.5rem">Tidak ada transaksi</div>
                            <p style="font-size:0.875rem;color:#64748b">Tidak ditemukan transaksi untuk periode dan filter yang dipilih</p>
                        </div>
                    `;
                    return;
                }
                
                // Group by supplier
                const bySupplier = {};
                filtered.forEach(t => {
                    if (!bySupplier[t.supplier]) {
                        bySupplier[t.supplier] = {
                            transactions: [],
                            total: 0,
                            supplierData: state.suppliers.find(s => s.nama === t.supplier)
                        };
                    }
                    bySupplier[t.supplier].transactions.push(t);
                    bySupplier[t.supplier].total += t.total;
                });
                
                // Render ringkasan
                const grandTotal = Object.values(bySupplier).reduce((sum, s) => sum + s.total, 0);
                document.getElementById('laporan-total').textContent = 'Rp ' + utils.formatRupiah(grandTotal);
                document.getElementById('laporan-count').textContent = filtered.length;
                document.getElementById('laporan-supplier-count').textContent = Object.keys(bySupplier).length;
                
                // Render detail
                const detailContainer = document.getElementById('laporan-detail');
                let html = '';
                
                Object.entries(bySupplier).sort((a, b) => b[1].total - a[1].total).forEach(([nama, data]) => {
                    const s = data.supplierData;
                    const bankInfo = s 
                        ? `<div class="bank-info">
                            <strong>${s.bank}</strong> | ${utils.escapeHtml(s.atasNama)}<br>
                            Rek: ${utils.formatRekening(s.rekening)}
                           </div>`
                        : '<div class="bank-info" style="color:#ef4444">‚ö†Ô∏è Data rekening tidak tersedia</div>';
                    
                    html += `
                        <div class="pembayaran-row">
                            <div class="pembayaran-info">
                                <div class="pembayaran-nama">${utils.escapeHtml(nama)}</div>
                                <div class="pembayaran-detail">${data.transactions.length} transaksi</div>
                                ${bankInfo}
                            </div>
                            <div class="pembayaran-jumlah">
                                Rp ${utils.formatRupiah(data.total)}
                            </div>
                        </div>
                    `;
                });
                
                detailContainer.innerHTML = html;
                
                // Update printable version
                document.getElementById('print-periode').textContent = `Periode: ${utils.formatDate(startDate)} s/d ${utils.formatDate(endDate)}`;
                document.getElementById('print-content').innerHTML = detailContainer.innerHTML;
                
                document.getElementById('laporan-content').style.display = 'block';
                document.getElementById('laporan-empty').style.display = 'none';
            };

            const resetLaporanFilter = () => {
                initLaporanDates();
                document.getElementById('laporan-status').value = 'all';
                generateLaporan();
            };

            const exportLaporanCSV = () => {
                const startDate = document.getElementById('laporan-start').value;
                const endDate = document.getElementById('laporan-end').value;
                
                // Recalculate data
                let filtered = state.transactions.filter(t => {
                    const tDate = new Date(t.tanggal);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59);
                    return tDate >= start && tDate <= end;
                });
                
                const bySupplier = {};
                filtered.forEach(t => {
                    if (!bySupplier[t.supplier]) {
                        bySupplier[t.supplier] = {
                            transactions: [],
                            total: 0,
                            supplierData: state.suppliers.find(s => s.nama === t.supplier)
                        };
                    }
                    bySupplier[t.supplier].transactions.push(t);
                    bySupplier[t.supplier].total += t.total;
                });
                
                const csvData = Object.entries(bySupplier).map(([nama, data]) => {
                    const s = data.supplierData || {};
                    return {
                        supplier: nama,
                        jumlah_transaksi: data.transactions.length,
                        total_pembayaran: data.total,
                        bank: s.bank || '-',
                        atas_nama: s.atasNama || '-',
                        no_rekening: s.rekening || '-'
                    };
                });
                
                const csv = Papa.unparse(csvData);
                const filename = `laporan_pembayaran_${startDate}_${endDate}.csv`;
                downloadFile(csv, filename, 'text/csv');
                ui.showToast('Laporan berhasil diexport!', 'success');
            };

            // ==========================================
            // SETTINGS FUNCTIONS
            // ==========================================
            
            const loadSettingsToForm = () => {
                document.getElementById('setting-nama').value = state.settings.namaPerusahaan;
                document.getElementById('setting-alamat').value = state.settings.alamat;
                document.getElementById('setting-telepon').value = state.settings.telepon;
                document.getElementById('setting-kota').value = state.settings.kota;
                document.getElementById('setting-floor').checked = state.settings.useFloor;
                document.getElementById('setting-desimal').value = state.settings.decimalPlaces;
                
                updatePreview();
                updateNettoHint();
            };

            const updatePreview = () => {
                const nama = document.getElementById('setting-nama').value || DEFAULT_SETTINGS.namaPerusahaan;
                const alamat = document.getElementById('setting-alamat').value || DEFAULT_SETTINGS.alamat;
                const telepon = document.getElementById('setting-telepon').value || DEFAULT_SETTINGS.telepon;
                
                document.getElementById('preview-nama').textContent = nama.toUpperCase();
                document.getElementById('preview-alamat').textContent = alamat;
                document.getElementById('preview-telepon').textContent = telepon ? `Telp: ${telepon}` : '';
            };

            const updateNettoHint = () => {
                const useFloor = document.getElementById('setting-floor').checked;
                const hint = document.getElementById('netto-hint');
                if (hint) {
                    hint.style.display = useFloor ? 'block' : 'none';
                }
            };

            const toggleFloorSetting = () => {
                updatePreview();
                updateNettoHint();
                calculateWeight();
            };

            const saveSettings = () => {
                state.settings = {
                    namaPerusahaan: utils.sanitizeInput(document.getElementById('setting-nama').value, 100) || DEFAULT_SETTINGS.namaPerusahaan,
                    alamat: utils.sanitizeInput(document.getElementById('setting-alamat').value, 200) || DEFAULT_SETTINGS.alamat,
                    telepon: utils.sanitizeInput(document.getElementById('setting-telepon').value, 20) || DEFAULT_SETTINGS.telepon,
                    kota: utils.sanitizeInput(document.getElementById('setting-kota').value, 50) || DEFAULT_SETTINGS.kota,
                    useFloor: document.getElementById('setting-floor').checked,
                    decimalPlaces: parseInt(document.getElementById('setting-desimal').value) || 2
                };

                if (storage.saveSettings()) {
                    ui.showToast('Pengaturan berhasil disimpan!', 'success');
                    updatePreview();
                    calculateWeight();
                } else {
                    ui.showToast('Gagal menyimpan pengaturan', 'error');
                }
            };

            const resetSettings = () => {
                if (confirm('Reset ke pengaturan default?')) {
                    state.settings = { ...DEFAULT_SETTINGS };
                    storage.saveSettings();
                    loadSettingsToForm();
                    ui.showToast('Pengaturan direset ke default', 'success');
                    calculateWeight();
                }
            };

            // ==========================================
            // CALCULATION
            // ==========================================
            
            const calculateWeight = () => {
                try {
                    const bruto = utils.validateNumber(document.getElementById('inp-bruto').value, 0, 100000, 2);
                    const tara = utils.validateNumber(document.getElementById('inp-tara').value, 0, 100000, 2);
                    const potonganPersen = utils.validateNumber(document.getElementById('inp-potongan').value, 0, 100, 2);
                    const harga = utils.validateNumber(document.getElementById('inp-harga').value, 0, 1000000000, 0);
                    const admin = utils.validateNumber(document.getElementById('inp-admin').value, 0, 100000000, 0);
                    
                    if (tara > bruto) {
                        document.getElementById('inp-tara').classList.add('error');
                    } else {
                        document.getElementById('inp-tara').classList.remove('error');
                    }
                    
                    const hasil = Math.max(0, bruto - tara);
                    const potonganKg = (hasil * potonganPersen) / 100;
                    let netto = Math.max(0, hasil - potonganKg);
                    
                    const useFloor = state.settings.useFloor;
                    const decimalPlaces = state.settings.decimalPlaces;
                    
                    if (useFloor) {
                        netto = Math.floor(netto);
                    } else {
                        netto = parseFloat(netto.toFixed(decimalPlaces));
                    }
                    
                    const subtotal = netto * harga;
                    const total = subtotal + admin;
                    
                    const nettoDisplay = useFloor ? 
                        netto.toString() : 
                        netto.toFixed(decimalPlaces);
                    
                    document.getElementById('inp-netto').value = nettoDisplay;
                    document.getElementById('calc-subtotal').textContent = utils.formatRupiah(subtotal);
                    document.getElementById('calc-admin').textContent = utils.formatRupiah(admin);
                    document.getElementById('calc-total').textContent = utils.formatRupiah(total);
                    
                    const status = document.getElementById('inp-status').value;
                    const groupDibayar = document.getElementById('group-dibayar');
                    const inputDibayar = document.getElementById('inp-dibayar');
                    const inputSisa = document.getElementById('inp-sisa');
                    
                    if (status === 'Lunas') {
                        groupDibayar.style.display = 'none';
                        if (inputSisa) inputSisa.value = utils.formatRupiah(0);
                    } else {
                        groupDibayar.style.display = 'block';
                        const dibayar = utils.validateNumber(inputDibayar?.value, 0, total, 0);
                        const sisa = status === 'Belum Lunas' ? total : Math.max(0, total - dibayar);
                        if (inputSisa) inputSisa.value = utils.formatRupiah(sisa);
                    }
                    
                } catch (e) {
                    console.error('Calculate error:', e);
                }
            };

            // ==========================================
            // SAVE TRANSACTION
            // ==========================================
            
            const saveTransaction = (e) => {
                e.preventDefault();
                
                if (state.isProcessing) return false;
                ui.setLoading(true);
                
                try {
                    if (state.transactions.length >= CONFIG.MAX_TRANSACTIONS && !state.editingId) {
                        ui.showToast(`Batas maksimal ${CONFIG.MAX_TRANSACTIONS} transaksi tercapai. Backup dan hapus data lama.`, 'error');
                        return false;
                    }
                    
                    const bruto = utils.validateNumber(document.getElementById('inp-bruto').value, 0, 100000, 2);
                    const tara = utils.validateNumber(document.getElementById('inp-tara').value, 0, 100000, 2);
                    const potonganPersen = utils.validateNumber(document.getElementById('inp-potongan').value, 0, 100, 2);
                    const hasil = Math.max(0, bruto - tara);
                    let netto = Math.max(0, hasil - ((hasil * potonganPersen) / 100));
                    
                    const useFloor = state.settings.useFloor;
                    const decimalPlaces = state.settings.decimalPlaces;
                    
                    if (useFloor) {
                        netto = Math.floor(netto);
                    } else {
                        netto = parseFloat(netto.toFixed(decimalPlaces));
                    }
                    
                    const harga = utils.validateNumber(document.getElementById('inp-harga').value, 0, 1000000000, 0);
                    const admin = utils.validateNumber(document.getElementById('inp-admin').value, 0, 100000000, 0);
                    const total = (netto * harga) + admin;
                    
                    const supplierName = document.getElementById('inp-supplier').value;
                    const supplierData = state.suppliers.find(s => s.nama === supplierName);
                    
                    const transaction = {
                        id: state.editingId || utils.generateId(),
                        tanggal: document.getElementById('inp-tanggal').value,
                        jam: document.getElementById('inp-jam').value,
                        supir: utils.sanitizeInput(document.getElementById('inp-supir').value),
                        plat: utils.sanitizeInput(document.getElementById('inp-plat').value).toUpperCase(),
                        supplier: supplierName,
                        supplierId: supplierData?.id || null, // FITUR BARU: Simpan ID supplier
                        bruto: bruto,
                        tara: tara,
                        potonganPersen: potonganPersen,
                        netto: netto,
                        harga: harga,
                        admin: admin,
                        total: total,
                        status: document.getElementById('inp-status').value,
                        sisa: document.getElementById('inp-status').value === 'Lunas' ? 0 : 
                              Math.max(0, total - utils.validateNumber(document.getElementById('inp-dibayar')?.value, 0, total, 0)),
                        useFloor: useFloor,
                        decimalPlaces: decimalPlaces,
                        createdAt: state.editingId ? state.transactions.find(t => t.id === state.editingId)?.createdAt || new Date().toISOString() : new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    const validation = validator.validateTransaction(transaction);
                    if (!validation.isValid) {
                        ui.showToast(validation.errors.join(', '), 'error');
                        ui.setLoading(false);
                        return false;
                    }
                    
                    if (state.editingId) {
                        const idx = state.transactions.findIndex(t => t.id === state.editingId);
                        if (idx !== -1) {
                            state.transactions[idx] = transaction;
                            ui.showToast('Transaksi berhasil diupdate!', 'success');
                        }
                        state.editingId = null;
                    } else {
                        state.transactions.unshift(transaction);
                        ui.showToast('Transaksi berhasil disimpan!', 'success');
                    }
                    
                    if (storage.save()) {
                        updateStats();
                        renderRecent();
                        renderHistory();
                        updateDatalists();
                        
                        setTimeout(() => {
                            if (!state.editingId && confirm('Cetak nota sekarang?')) {
                                showNota(transaction.id);
                            } else {
                                resetForm();
                            }
                        }, 100);
                    }
                    
                } catch (err) {
                    console.error('Save error:', err);
                    ui.showToast('Terjadi kesalahan: ' + err.message, 'error');
                } finally {
                    ui.setLoading(false);
                }
                
                return false;
            };

            const resetForm = () => {
                document.getElementById('form-transaksi').reset();
                state.editingId = null;
                initDateTime();
                document.getElementById('inp-potongan').value = '0';
                document.getElementById('inp-admin').value = '0';
                document.getElementById('btn-submit').innerHTML = '<span>üíæ</span> Simpan Transaksi';
                document.getElementById('supplier-info-display').style.display = 'none';
                updateNettoHint();
                calculateWeight();
            };

            // ==========================================
            // DISPLAY FUNCTIONS
            // ==========================================
            
            const updateStats = () => {
                const total = state.transactions.length;
                const totalBerat = state.transactions.reduce((sum, t) => sum + (t.netto || 0), 0);
                const totalNilai = state.transactions.reduce((sum, t) => sum + (t.total || 0), 0);
                const pending = state.transactions.filter(t => t.status !== 'Lunas').length;
                const supplierCount = state.suppliers.length; // FITUR BARU
                
                document.getElementById('stat-total').textContent = total.toLocaleString('id-ID');
                document.getElementById('stat-berat').textContent = totalBerat.toFixed(2);
                document.getElementById('stat-nilai').textContent = (totalNilai / 1000000).toFixed(1) + 'M';
                document.getElementById('stat-pending').textContent = pending.toLocaleString('id-ID');
                document.getElementById('stat-supplier').textContent = supplierCount.toLocaleString('id-ID'); // FITUR BARU
            };

            const renderRecent = () => {
                const container = document.getElementById('recent-list');
                const recent = state.transactions.slice(0, 5);
                
                if (recent.length === 0) {
                    container.innerHTML = `
                        <div class="empty">
                            <div class="empty-icon">üì≠</div>
                            <div style="font-weight:600;margin-bottom:0.5rem">Belum ada transaksi</div>
                            <p style="font-size:0.875rem">Mulai dengan menambahkan transaksi baru</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = recent.map(t => {
                    const icon = t.status === 'Lunas' ? '‚úÖ' : (t.status === 'Dicicil' ? '‚è≥' : '‚ùå');
                    const nettoDisplay = t.useFloor ? 
                        Math.floor(t.netto) : 
                        t.netto.toFixed(t.decimalPlaces || 2);
                    
                    return `
                        <div class="recent-item" onclick="app.showNota('${utils.escapeHtml(t.id)}')">
                            <div class="recent-icon">${icon}</div>
                            <div class="recent-info">
                                <div class="recent-title">${utils.escapeHtml(t.supir)} - ${utils.escapeHtml(t.plat)}</div>
                                <div class="recent-meta">${utils.formatDate(t.tanggal)} ‚Ä¢ ${utils.escapeHtml(t.supplier)}</div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-weight:600">Rp ${utils.formatRupiah(t.total)}</div>
                                <div style="font-size:0.75rem;color:#64748b">${nettoDisplay} kg</div>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            const renderHistory = () => {
                const tbody = document.getElementById('tbody-riwayat');
                const search = utils.sanitizeInput(document.getElementById('filter-search')?.value || '', 50).toLowerCase();
                const statusFilter = document.getElementById('filter-status')?.value || '';
                const tanggalFilter = document.getElementById('filter-tanggal')?.value || '';
                
                let filtered = state.transactions.filter(t => {
                    const matchSearch = !search || 
                        (t.supir?.toLowerCase().includes(search)) ||
                        (t.plat?.toLowerCase().includes(search)) ||
                        (t.supplier?.toLowerCase().includes(search));
                    const matchStatus = !statusFilter || t.status === statusFilter;
                    const matchTanggal = !tanggalFilter || t.tanggal === tanggalFilter;
                    return matchSearch && matchStatus && matchTanggal;
                });
                
                const totalPages = Math.ceil(filtered.length / CONFIG.ITEMS_PER_PAGE);
                const start = (state.currentPage - 1) * CONFIG.ITEMS_PER_PAGE;
                const paginated = filtered.slice(start, start + CONFIG.ITEMS_PER_PAGE);
                
                if (paginated.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align:center;padding:3rem">
                                <div class="empty">
                                    <div class="empty-icon">üîç</div>
                                    <div style="font-weight:600">Tidak ada data</div>
                                    <p style="font-size:0.875rem">Coba ubah filter pencarian</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    renderPagination(0, 0);
                    return;
                }
                
                tbody.innerHTML = paginated.map(t => {
                    const badgeClass = t.status === 'Lunas' ? 'badge-success' : 
                                      (t.status === 'Dicicil' ? 'badge-warning' : 'badge-danger');
                    const nettoDisplay = t.useFloor ? 
                        Math.floor(t.netto) : 
                        t.netto.toFixed(t.decimalPlaces || 2);
                    
                    return `
                        <tr>
                            <td>${utils.formatDate(t.tanggal)}<br><small style="color:#64748b">${utils.escapeHtml(t.jam)}</small></td>
                            <td>${utils.escapeHtml(t.supir)}</td>
                            <td>${utils.escapeHtml(t.plat)}</td>
                            <td>${utils.escapeHtml(t.supplier)}</td>
                            <td>${nettoDisplay} kg</td>
                            <td>Rp ${utils.formatRupiah(t.total)}</td>
                            <td><span class="badge ${badgeClass}">${utils.escapeHtml(t.status)}</span></td>
                            <td class="no-print">
                                <div class="action-btns">
                                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation();app.showNota('${utils.escapeHtml(t.id)}')" title="Cetak">üñ®Ô∏è</button>
                                    <button class="btn btn-warning btn-sm" onclick="event.stopPropagation();app.editTransaction('${utils.escapeHtml(t.id)}')" title="Edit">‚úèÔ∏è</button>
                                    <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();app.deleteTransaction('${utils.escapeHtml(t.id)}')" title="Hapus">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                renderPagination(totalPages, filtered.length);
            };

            const renderPagination = (totalPages, totalItems) => {
                const container = document.getElementById('pagination');
                if (totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }
                
                let html = `<span style="color:#64748b;font-size:0.875rem">Total: ${totalItems} | Halaman ${state.currentPage} dari ${totalPages}</span><div style="display:flex;gap:0.25rem">`;
                
                html += `<button class="page-btn" onclick="app.changePage(${state.currentPage - 1})" ${state.currentPage === 1 ? 'disabled' : ''}>‚Üê</button>`;
                
                const startPage = Math.max(1, state.currentPage - 2);
                const endPage = Math.min(totalPages, startPage + 4);
                
                for (let i = startPage; i <= endPage; i++) {
                    html += `<button class="page-btn ${i === state.currentPage ? 'active' : ''}" onclick="app.changePage(${i})">${i}</button>`;
                }
                
                html += `<button class="page-btn" onclick="app.changePage(${state.currentPage + 1})" ${state.currentPage === totalPages ? 'disabled' : ''}>‚Üí</button></div>`;
                
                container.innerHTML = html;
            };

            const changePage = (page) => {
                state.currentPage = page;
                renderHistory();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const debounceRender = utils.debounce(renderHistory, CONFIG.DEBOUNCE_DELAY);

            const updateDatalists = () => {
                const supirs = [...new Set(state.transactions.map(t => t.supir).filter(Boolean))].slice(0, 50);
                const plats = [...new Set(state.transactions.map(t => t.plat).filter(Boolean))].slice(0, 50);
                
                fillDatalist('list-supir', supirs);
                fillDatalist('list-plat', plats);
                // Supplier sekarang menggunakan select, bukan datalist
            };

            const fillDatalist = (id, items) => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = items.map(i => `<option value="${utils.escapeHtml(i)}">`).join('');
                }
            };

            const clearFilter = () => {
                document.getElementById('filter-search').value = '';
                document.getElementById('filter-status').value = '';
                document.getElementById('filter-tanggal').value = '';
                state.currentPage = 1;
                renderHistory();
            };

            const editTransaction = (id) => {
                const t = state.transactions.find(x => x.id === id);
                if (!t) {
                    ui.showToast('Transaksi tidak ditemukan', 'error');
                    return;
                }
                
                state.editingId = id;
                
                document.getElementById('inp-tanggal').value = t.tanggal;
                document.getElementById('inp-jam').value = t.jam;
                document.getElementById('inp-supir').value = t.supir;
                document.getElementById('inp-plat').value = t.plat;
                document.getElementById('inp-supplier').value = t.supplier;
                document.getElementById('inp-bruto').value = t.bruto;
                document.getElementById('inp-tara').value = t.tara;
                document.getElementById('inp-potongan').value = t.potonganPersen;
                document.getElementById('inp-harga').value = t.harga;
                document.getElementById('inp-admin').value = t.admin;
                document.getElementById('inp-status').value = t.status;
                
                // Trigger supplier change untuk menampilkan info rekening
                onSupplierChange();
                
                const groupDibayar = document.getElementById('group-dibayar');
                const inputDibayar = document.getElementById('inp-dibayar');
                
                if (t.status !== 'Lunas') {
                    groupDibayar.style.display = 'block';
                    const dibayar = t.total - t.sisa;
                    inputDibayar.value = dibayar > 0 ? dibayar : '';
                } else {
                    groupDibayar.style.display = 'none';
                    inputDibayar.value = '';
                }
                
                document.getElementById('btn-submit').innerHTML = '<span>üíæ</span> Update Transaksi';
                
                calculateWeight();
                
                const inputBtn = document.querySelectorAll('.nav-btn')[1];
                switchTab('input', inputBtn);
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                ui.showToast('Mode edit aktif - silakan ubah data dan simpan', 'info');
            };

            const showNota = (id) => {
                const t = state.transactions.find(x => x.id === id);
                if (!t) {
                    ui.showToast('Transaksi tidak ditemukan', 'error');
                    return;
                }
                
                const useFloor = t.useFloor !== undefined ? t.useFloor : state.settings.useFloor;
                const decimalPlaces = t.decimalPlaces !== undefined ? t.decimalPlaces : state.settings.decimalPlaces;
                
                document.getElementById('nota-nama-perusahaan').textContent = state.settings.namaPerusahaan.toUpperCase();
                document.getElementById('nota-alamat').textContent = state.settings.alamat;
                document.getElementById('nota-telepon').textContent = state.settings.telepon ? `Telp: ${state.settings.telepon}` : '';
                
                document.getElementById('nota-no').textContent = 'TRX-' + String(t.id).slice(-12);
                document.getElementById('nota-tanggal').textContent = utils.formatDate(t.tanggal) + ' ' + t.jam;
                document.getElementById('nota-supir').textContent = t.supir;
                document.getElementById('nota-plat').textContent = t.plat;
                document.getElementById('nota-supplier').textContent = t.supplier;
                document.getElementById('nota-bruto').textContent = t.bruto.toFixed(2) + ' kg';
                document.getElementById('nota-tara').textContent = t.tara.toFixed(2) + ' kg';
                document.getElementById('nota-potongan').textContent = t.potonganPersen + '%';
                
                const nettoDisplay = useFloor ? 
                    Math.floor(t.netto) + ' kg' : 
                    t.netto.toFixed(decimalPlaces) + ' kg';
                document.getElementById('nota-netto').textContent = nettoDisplay;
                
                document.getElementById('nota-harga').textContent = 'Rp ' + utils.formatRupiah(t.harga) + '/kg';
                document.getElementById('nota-total').textContent = 'Rp ' + utils.formatRupiah(t.total);
                document.getElementById('nota-status').textContent = t.status;
                
                document.getElementById('modal-nota').classList.add('active');
            };

            const closeNota = () => {
                document.getElementById('modal-nota').classList.remove('active');
            };

            const deleteTransaction = (id) => {
                if (!confirm('Yakin ingin menghapus transaksi ini? Tindakan ini tidak dapat dibatalkan.')) return;
                
                const initialLength = state.transactions.length;
                state.transactions = state.transactions.filter(t => t.id !== id);
                
                if (state.transactions.length < initialLength) {
                    if (storage.save()) {
                        updateStats();
                        renderRecent();
                        renderHistory();
                        updateDatalists();
                        ui.showToast('Transaksi berhasil dihapus', 'success');
                    }
                } else {
                    ui.showToast('Transaksi tidak ditemukan', 'error');
                }
            };

            // ==========================================
            // IMPORT/EXPORT
            // ==========================================
            
            const importCSV = (input) => {
                const file = input.files[0];
                if (!file) return;
                
                if (file.size > 5 * 1024 * 1024) {
                    ui.showToast('File terlalu besar (maksimal 5MB)', 'error');
                    return;
                }
                
                ui.setLoading(true);
                
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: 'UTF-8',
                    complete: (results) => {
                        ui.setLoading(false);
                        if (results.errors.length > 0) {
                            console.warn('CSV parse warnings:', results.errors);
                        }
                        state.currentImport = results.data.filter(row => row.supir || row.nama_supir).slice(0, 1000);
                        showPreview(state.currentImport, results.meta.fields);
                    },
                    error: (err) => {
                        ui.setLoading(false);
                        ui.showToast('Error parsing CSV: ' + err.message, 'error');
                    }
                });
            };

            const showPreview = (data, fields) => {
                document.getElementById('preview-count').textContent = data.length;
                document.getElementById('preview-section').style.display = 'block';
                
                const table = document.getElementById('table-preview');
                const displayFields = fields.slice(0, 6);
                
                table.querySelector('thead').innerHTML = '<tr>' + displayFields.map(f => `<th>${utils.escapeHtml(f)}</th>`).join('') + '</tr>';
                
                const rows = data.slice(0, 5).map(row => 
                    '<tr>' + displayFields.map(f => `<td>${utils.escapeHtml(String(row[f] || '').slice(0, 50))}</td>`).join('') + '</tr>'
                ).join('');
                
                const more = data.length > 5 ? 
                    `<tr><td colspan="${displayFields.length}" style="text-align:center;color:#666">... dan ${data.length - 5} baris lainnya</td></tr>` : '';
                
                table.querySelector('tbody').innerHTML = rows + more;
            };

            const processImport = () => {
                if (!state.currentImport.length) return;
                
                if (state.transactions.length + state.currentImport.length > CONFIG.MAX_TRANSACTIONS) {
                    ui.showToast(`Import akan melebihi batas ${CONFIG.MAX_TRANSACTIONS} transaksi`, 'error');
                    return;
                }
                
                ui.setLoading(true);
                let success = 0;
                let failed = 0;
                
                setTimeout(() => {
                    state.currentImport.forEach(row => {
                        try {
                            const bruto = utils.validateNumber(row.bruto || row.berat_kotor || 0, 0, 100000, 2);
                            const tara = utils.validateNumber(row.tara || 0, 0, 100000, 2);
                            const potongan = utils.validateNumber(row.potongan || row.potongan_persen || 0, 0, 100, 2);
                            const hasil = Math.max(0, bruto - tara);
                            let netto = Math.max(0, hasil - ((hasil * potongan) / 100));
                            
                            if (state.settings.useFloor) {
                                netto = Math.floor(netto);
                            } else {
                                netto = parseFloat(netto.toFixed(state.settings.decimalPlaces));
                            }
                            
                            const harga = utils.validateNumber(row.harga || row.harga_per_kg || 0, 0, 1000000000, 0);
                            const admin = utils.validateNumber(row.admin || row.biaya_admin || 0, 0, 100000000, 0);
                            
                            const transaction = {
                                id: utils.generateId(),
                                tanggal: row.tanggal && /^\d{4}-\d{2}-\d{2}$/.test(row.tanggal) ? row.tanggal : new Date().toISOString().split('T')[0],
                                jam: row.jam && /^\d{2}:\d{2}$/.test(row.jam) ? row.jam : '00:00',
                                supir: utils.sanitizeInput(row.supir || row.nama_supir || ''),
                                plat: utils.sanitizeInput(row.plat || row.plat_nomor || '').toUpperCase(),
                                supplier: utils.sanitizeInput(row.supplier || row.nama_supplier || ''),
                                bruto, tara, potonganPersen: potongan, netto,
                                harga, admin,
                                total: (netto * harga) + admin,
                                status: ['Lunas', 'Dicicil', 'Belum Lunas'].includes(row.status) ? row.status : 'Lunas',
                                useFloor: state.settings.useFloor,
                                decimalPlaces: state.settings.decimalPlaces,
                                createdAt: new Date().toISOString()
                            };
                            
                            const validation = validator.validateTransaction(transaction);
                            if (validation.isValid) {
                                state.transactions.push(transaction);
                                success++;
                            } else {
                                failed++;
                            }
                        } catch (e) {
                            failed++;
                        }
                    });
                    
                    if (success > 0) {
                        storage.save();
                        updateStats();
                        renderRecent();
                        renderHistory();
                        updateDatalists();
                    }
                    
                    ui.setLoading(false);
                    cancelImport();
                    ui.showToast(`Import selesai: ${success} sukses, ${failed} gagal`, failed > 0 ? 'warning' : 'success');
                }, 100);
            };

            const cancelImport = () => {
                state.currentImport = [];
                document.getElementById('file-csv').value = '';
                document.getElementById('preview-section').style.display = 'none';
            };

            const exportCSV = () => {
                if (!state.transactions.length) {
                    ui.showToast('Tidak ada data untuk export!', 'error');
                    return;
                }
                
                const csv = Papa.unparse(state.transactions.map(t => ({
                    tanggal: t.tanggal,
                    jam: t.jam,
                    supir: t.supir,
                    plat: t.plat,
                    supplier: t.supplier,
                    bruto: t.bruto,
                    tara: t.tara,
                    potongan_persen: t.potonganPersen,
                    netto: t.netto,
                    harga_per_kg: t.harga,
                    biaya_admin: t.admin,
                    total: t.total,
                    status: t.status
                })));
                
                downloadFile(csv, `transaksi_gasjaya_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
                ui.showToast('File CSV berhasil diunduh!', 'success');
            };

            const downloadTemplate = () => {
                const csv = 'tanggal,jam,supir,plat,supplier,bruto,tara,potongan,harga,admin,status\n';
                const example = '2024-01-15,08:30,Budi Santono,B 1234 ABC,PT Gas Makmur,5000,1500,2,8500,50000,Lunas\n';
                downloadFile(csv + example, 'template_gasjaya.csv', 'text/csv');
                ui.showToast('Template diunduh!', 'success');
            };

            // ==========================================
            // BACKUP & RESTORE
            // ==========================================
            
            const backupJSON = () => {
                const payload = {
                    data: state.transactions,
                    suppliers: state.suppliers, // FITUR BARU: Include suppliers
                    settings: state.settings,
                    version: CONFIG.VERSION,
                    exportedAt: new Date().toISOString(),
                    checksum: utils.calculateChecksum(state.transactions)
                };
                
                const json = JSON.stringify(payload, null, 2);
                downloadFile(json, `backup_gasjaya_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
                ui.showToast('Backup berhasil dibuat!', 'success');
            };

            const restoreJSON = (input) => {
                const file = input.files[0];
                if (!file) return;
                
                if (file.size > 10 * 1024 * 1024) {
                    ui.showToast('File terlalu besar (maksimal 10MB)', 'error');
                    return;
                }
                
                ui.setLoading(true);
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const payload = JSON.parse(e.target.result);
                        
                        if (!payload.data || !Array.isArray(payload.data)) {
                            throw new Error('Format file tidak valid');
                        }
                        
                        if (payload.checksum) {
                            const currentChecksum = utils.calculateChecksum(payload.data);
                            if (currentChecksum !== payload.checksum) {
                                if (!confirm('Peringatan: File mungkin korup. Lanjutkan?')) {
                                    ui.setLoading(false);
                                    return;
                                }
                            }
                        }
                        
                        const restored = payload.data.slice(0, CONFIG.MAX_TRANSACTIONS);
                        
                        if (confirm(`Restore ${restored.length} transaksi? Data akan digabungkan dengan data existing.`)) {
                            state.transactions = [...restored, ...state.transactions].slice(0, CONFIG.MAX_TRANSACTIONS);
                            
                            // Restore suppliers jika ada
                            if (payload.suppliers && Array.isArray(payload.suppliers)) {
                                const existingNames = new Set(state.suppliers.map(s => s.nama.toLowerCase()));
                                const newSuppliers = payload.suppliers.filter(s => !existingNames.has(s.nama.toLowerCase()));
                                state.suppliers = [...state.suppliers, ...newSuppliers].slice(0, CONFIG.MAX_SUPPLIERS);
                                storage.saveSuppliers();
                                populateSupplierSelect();
                            }
                            
                            if (payload.settings) {
                                state.settings = { ...DEFAULT_SETTINGS, ...payload.settings };
                                storage.saveSettings();
                                loadSettingsToForm();
                            }
                            
                            if (storage.save()) {
                                updateStats();
                                renderRecent();
                                renderHistory();
                                updateDatalists();
                                ui.showToast(`Berhasil restore ${restored.length} transaksi!`, 'success');
                            }
                        }
                    } catch (err) {
                        ui.showToast('File tidak valid: ' + err.message, 'error');
                    } finally {
                        ui.setLoading(false);
                        input.value = '';
                    }
                };
                
                reader.onerror = () => {
                    ui.setLoading(false);
                    ui.showToast('Gagal membaca file', 'error');
                    input.value = '';
                };
                
                reader.readAsText(file);
            };

            // ==========================================
            // UTILITIES
            // ==========================================
            
            const downloadFile = (content, filename, type) => {
                const blob = new Blob([content], { type: type + ';charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            };

            // ==========================================
            // EVENT HANDLERS
            // ==========================================
            
            const initOnlineDetection = () => {
                const updateStatus = () => ui.updateConnectionStatus();
                window.addEventListener('online', updateStatus);
                window.addEventListener('offline', updateStatus);
                if (!navigator.onLine) updateStatus();
            };

            const initDragDrop = () => {
                const zone = document.getElementById('upload-zone');
                if (!zone) return;
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    zone.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    }, false);
                });
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    zone.addEventListener(eventName, () => zone.classList.add('dragover'), false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    zone.addEventListener(eventName, () => zone.classList.remove('dragover'), false);
                });
                
                zone.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files.length) {
                        document.getElementById('file-csv').files = files;
                        importCSV({ target: { files: files } });
                    }
                }, false);
            };

            const initSettingsListeners = () => {
                ['setting-nama', 'setting-alamat', 'setting-telepon'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', updatePreview);
                    }
                });
            };

            // ==========================================
            // PUBLIC API
            // ==========================================
            return {
                init,
                switchTab,
                calculateWeight,
                saveTransaction,
                resetForm,
                renderHistory: debounceRender,
                debounceRender,
                clearFilter,
                showNota,
                closeNota,
                deleteTransaction,
                editTransaction,
                changePage,
                importCSV,
                processImport,
                cancelImport,
                exportCSV,
                downloadTemplate,
                backupJSON,
                restoreJSON,
                saveSettings,
                resetSettings,
                toggleFloorSetting,
                // FITUR BARU: Supplier API
                openSupplierModal,
                closeSupplierModal,
                saveSupplier,
                deleteSupplier,
                renderSupplierList,
                onSupplierChange,
                // FITUR BARU: Laporan API
                generateLaporan,
                resetLaporanFilter,
                exportLaporanCSV,
                // Expose for debugging
                _state: () => state,
                _config: CONFIG
            };
        })();

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', app.init);
        } else {
            app.init();
        }
    </script>
</body>
</html>
