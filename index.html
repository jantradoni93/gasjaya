<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Timbangan Gas Jaya - Full Cloud & Potongan</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCN0VeIOgPIK-MNPFoNzqw-GnwZXs9Dk8A",
            authDomain: "gasjaya-e24de.firebaseapp.com",
            projectId: "gasjaya-e24de",
            storageBucket: "gasjaya-e24de.firebasestorage.app",
            messagingSenderId: "924363516081",
            appId: "1:924363516081:web:fd90386ab0040368bc5a90"
        };

        const appFirebase = initializeApp(firebaseConfig);
        const db = getFirestore(appFirebase);
        enableIndexedDbPersistence(db).catch(() => console.log("Offline mode active"));

        window.dbCollection = collection(db, "transaksi_gas");
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        /* CSS Lengkap */
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#2563eb;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--bg:#f8fafc;--card:#fff;--text:#1e293b;--border:#e2e8f0}
        body{font-family:-apple-system,sans-serif;background:var(--bg);color:var(--text);padding-bottom:2rem}
        .header{background:linear-gradient(135deg,var(--primary)0%,#1d4ed8 100%);color:#fff;padding:1rem;position:sticky;top:0;z-index:100}
        .container{max-width:1200px;margin:0 auto;padding:1rem}
        .nav{display:flex;gap:0.5rem;overflow-x:auto;padding:1rem 0}
        .nav-btn{padding:0.6rem 1rem;background:rgba(255,255,255,0.1);border:none;color:#fff;border-radius:0.5rem;cursor:pointer;white-space:nowrap}
        .nav-btn.active{background:#fff;color:var(--primary);font-weight:bold}
        .card{background:#fff;border-radius:0.75rem;padding:1.25rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:1rem}
        .form-grid{display:grid;grid-template-columns:1fr;gap:1rem}
        @media(min-width:768px){.form-grid{grid-template-columns:1fr 1fr}}
        .form-group{margin-bottom:1rem}
        label{display:block;font-size:0.875rem;font-weight:600;margin-bottom:0.25rem}
        input,select{width:100%;padding:0.75rem;border:1px solid var(--border);border-radius:0.5rem;font-size:16px}
        .btn{padding:0.75rem 1rem;border:none;border-radius:0.5rem;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:0.5rem}
        .btn-primary{background:var(--primary);color:#fff;width:100%}
        table{width:100%;border-collapse:collapse}
        th,td{padding:0.75rem;text-align:left;border-bottom:1px solid var(--border);font-size:0.875rem}
        .toast{position:fixed;bottom:1rem;right:1rem;background:#fff;padding:1rem;border-radius:0.5rem;box-shadow:0 10px 15px rgba(0,0,0,0.1);display:none;z-index:1000}
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>

    <header class="header">
        <div class="container">
            <h2>‚öñÔ∏è Timbangan Gas Jaya</h2>
            <nav class="nav">
                <button class="nav-btn active" onclick="app.switchTab('dashboard', this)">üìä Dash</button>
                <button class="nav-btn" onclick="app.switchTab('input', this)">üìù Input</button>
                <button class="nav-btn" onclick="app.switchTab('riwayat', this)">üìã Riwayat</button>
                <button class="nav-btn" onclick="app.switchTab('supplier', this)">üè¢ Supplier</button>
            </nav>
        </div>
    </header>

    <main class="container">
        <section id="dashboard" class="tab-content">
            <div class="card">
                <h3>Ringkasan</h3>
                <p>Total Transaksi: <span id="stat-total">0</span></p>
                <p>Total Netto: <span id="stat-berat">0</span> kg</p>
            </div>
        </section>

        <section id="input" class="tab-content" style="display:none">
            <div class="card">
                <form onsubmit="return app.save(event)">
                    <div class="form-grid">
                        <div class="form-group"><label>Nama Supir</label><input type="text" id="inp-nama" required></div>
                        <div class="form-group"><label>Supplier</label><select id="inp-supplier" required></select></div>
                        <div class="form-group"><label>Bruto (Kg)</label><input type="number" step="0.01" id="inp-bruto" oninput="app.calculate()" required></div>
                        <div class="form-group"><label>Tara (Kg)</label><input type="number" step="0.01" id="inp-tara" oninput="app.calculate()" required></div>
                        
                        <div class="form-group"><label>Potongan (%)</label><input type="number" id="inp-potongan" value="0" oninput="app.calculate()"></div>
                        
                        <div class="form-group"><label>Netto Akhir (Kg)</label><input type="number" id="inp-netto" readonly style="background:#f1f5f9;font-weight:bold"></div>
                        <div class="form-group"><label>Harga / Kg</label><input type="number" id="inp-harga" oninput="app.calculate()"></div>
                    </div>
                    <h3 id="display-total" style="color:var(--primary); margin:1rem 0">Total: Rp 0</h3>
                    <button type="submit" class="btn btn-primary">üíæ Simpan ke Cloud</button>
                </form>
            </div>
        </section>

        <section id="riwayat" class="tab-content" style="display:none">
            <div class="card">
                <div style="overflow-x:auto">
                    <table>
                        <thead><tr><th>Tgl</th><th>Nama</th><th>Netto</th><th>Total</th></tr></thead>
                        <tbody id="list-riwayat"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="supplier" class="tab-content" style="display:none">
            <div class="card">
                <h3>Manajemen Supplier</h3>
                <input type="text" id="new-sup" placeholder="Nama Supplier Baru">
                <button class="btn btn-primary" onclick="app.addSup()" style="margin-top:0.5rem">+ Tambah</button>
                <div id="div-sup" style="margin-top:1rem"></div>
            </div>
        </section>
    </main>

    <script>
        const app = (() => {
            let state = {
                tx: JSON.parse(localStorage.getItem('gas_tx_v3') || '[]'),
                sups: JSON.parse(localStorage.getItem('gas_sups_v3') || '["GUDANG PUSAT"]')
            };

            const init = () => { render(); };

            const calculate = () => {
                const b = parseFloat(document.getElementById('inp-bruto').value) || 0;
                const t = parseFloat(document.getElementById('inp-tara').value) || 0;
                const p = parseFloat(document.getElementById('inp-potongan').value) || 0;
                const h = parseFloat(document.getElementById('inp-harga').value) || 0;

                // Rumus: (Bruto - Tara) dipotong persentase
                let bersih = b - t;
                if(p > 0) bersih = bersih - (bersih * p / 100);
                
                document.getElementById('inp-netto').value = bersih.toFixed(2);
                document.getElementById('display-total').innerText = `Total: Rp ${(bersih * h).toLocaleString()}`;
            };

            const save = async (e) => {
                e.preventDefault();
                const data = {
                    id: Date.now(),
                    tgl: new Date().toLocaleDateString(),
                    nama: document.getElementById('inp-nama').value,
                    sup: document.getElementById('inp-supplier').value,
                    bruto: document.getElementById('inp-bruto').value,
                    tara: document.getElementById('inp-tara').value,
                    potongan: document.getElementById('inp-potongan').value,
                    netto: document.getElementById('inp-netto').value,
                    total: parseFloat(document.getElementById('inp-netto').value) * (parseFloat(document.getElementById('inp-harga').value) || 0)
                };

                state.tx.unshift(data);
                localStorage.setItem('gas_tx_v3', JSON.stringify(state.tx));

                if(window.dbCollection) {
                    await window.addDoc(window.dbCollection, {...data, cloud_time: window.serverTimestamp()});
                }

                alert("Data Berhasil Disimpan & Sinkron!");
                e.target.reset();
                render();
                switchTab('dashboard', document.querySelectorAll('.nav-btn')[0]);
            };

            const render = () => {
                document.getElementById('stat-total').innerText = state.tx.length;
                document.getElementById('stat-berat').innerText = state.tx.reduce((a,b) => a + parseFloat(b.netto), 0).toFixed(2);
                document.getElementById('inp-supplier').innerHTML = state.sups.map(s => `<option value="${s}">${s}</option>`).join('');
                document.getElementById('div-sup').innerHTML = state.sups.map(s => `<div>${s}</div>`).join('');
                document.getElementById('list-riwayat').innerHTML = state.tx.map(t => `
                    <tr><td>${t.tgl}</td><td>${t.nama}</td><td>${t.netto} kg</td><td>Rp ${t.total.toLocaleString()}</td></tr>
                `).join('');
            };

            const switchTab = (id, btn) => {
                document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
                document.getElementById(id).style.display = 'block';
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };

            const addSup = () => {
                const n = document.getElementById('new-sup').value;
                if(n) { state.sups.push(n.toUpperCase()); localStorage.setItem('gas_sups_v3', JSON.stringify(state.sups)); render(); }
            };

            return { init, calculate, save, switchTab, addSup };
        })();
        app.init();
    </script>
</body>
</html>
